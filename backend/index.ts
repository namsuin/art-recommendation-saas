import { testSupabaseConnection, supabase } from "./services/supabase";
import { AIAnalysisService } from "./services/ai-analysis";
import { AuthAPI } from "./api/auth";
import { AdminAPI } from "./api/admin";
import { PurchaseAPI } from "./api/purchase";
import { MultiImageAPI } from "./api/multi-image";
import { StripeService, SUBSCRIPTION_PLANS } from "./services/stripe";
import { AnalyticsService } from "./services/analytics";
import { RecommendationsV2API } from "./routes/recommendations-v2";
import { SocialFeaturesService } from "./services/social-features";
import { printEnvironmentStatus, validateEnvironment } from "./utils/env-validator";
import { serveIndexHTML, serveStaticFile } from "./routes/static";

interface WebSocketData {
  message: string;
  timestamp: number;
}

// Initialize AI Analysis Service (lazy initialization)
let aiService: AIAnalysisService | null = null;
let recommendationsV2API: RecommendationsV2API | null = null;
let socialFeaturesService: SocialFeaturesService | null = null;
let multiImageAPI: MultiImageAPI | null = null;

function getAIService(): AIAnalysisService {
  if (!aiService) {
    console.log('üîß Creating new AI Analysis Service...');
    aiService = new AIAnalysisService();
    console.log('üéØ AI Analysis Service created successfully');
  }
  return aiService;
}

function getRecommendationsV2API(): RecommendationsV2API {
  if (!recommendationsV2API) {
    recommendationsV2API = new RecommendationsV2API();
  }
  return recommendationsV2API;
}

function getSocialFeaturesService(): SocialFeaturesService {
  if (!socialFeaturesService) {
    socialFeaturesService = new SocialFeaturesService();
  }
  return socialFeaturesService;
}

function getMultiImageAPI(): MultiImageAPI {
  if (!multiImageAPI) {
    multiImageAPI = new MultiImageAPI();
  }
  return multiImageAPI;
}

// Validate environment on startup
printEnvironmentStatus();
const envValidation = validateEnvironment();

if (!envValidation.isValid) {
  console.error('\n‚ùå Critical environment configuration errors detected!');
  console.error('Please check your .env file and fix the errors above.');
  process.exit(1);
}

const server = Bun.serve({
  port: 3000,
  hostname: "0.0.0.0",
  
  routes: {
    "/": {
      GET: () => serveIndexHTML()
    },
    
    // Static file serving
    "/app.tsx": {
      GET: () => serveStaticFile('app.tsx')
    },
    "/components/*": {
      GET: (req) => {
        const url = new URL(req.url);
        const filePath = url.pathname.substring(1); // Remove leading slash
        return serveStaticFile(filePath);
      }
    },
    "/hooks/*": {
      GET: (req) => {
        const url = new URL(req.url);
        const filePath = url.pathname.substring(1); // Remove leading slash
        return serveStaticFile(filePath);
      }
    },
    "/styles/*": {
      GET: (req) => {
        const url = new URL(req.url);
        const filePath = url.pathname.substring(1); // Remove leading slash
        return serveStaticFile(filePath);
      }
    },
    "/dist/*": {
      GET: (req) => {
        const url = new URL(req.url);
        const filePath = url.pathname.substring(1); // Remove leading slash
        return serveStaticFile(filePath);
      }
    },
    
    "/api/health": {
      GET: async () => {
        try {
          const supabaseHealthy = await testSupabaseConnection();
          let aiStatus = null;
          
          try {
            aiStatus = await getAIService().getServiceStatus();
          } catch (aiError) {
            console.warn("AI service status check failed:", aiError);
            aiStatus = { error: "AI service initialization failed" };
          }
          
          return new Response(JSON.stringify({ 
            status: "healthy", 
            timestamp: Date.now(),
            services: {
              supabase: supabaseHealthy ? "connected" : "disconnected",
              ai_services: aiStatus
            }
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error("Health check failed:", error);
          return new Response(JSON.stringify({
            status: "error",
            error: error instanceof Error ? error.message : "Unknown error",
            timestamp: Date.now()
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/ai/test": {
      GET: async () => {
        try {
          const testResults = await getAIService().testServices();
          const serviceStatus = await getAIService().getServiceStatus();
          
          return new Response(JSON.stringify({
            status: "success",
            test_results: testResults,
            service_status: serviceStatus,
            timestamp: Date.now()
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          return new Response(JSON.stringify({
            status: "error",
            error: error instanceof Error ? error.message : "Unknown error",
            timestamp: Date.now()
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/analyze": {
      POST: async (req) => {
        try {
          const formData = await req.formData();
          const imageFile = formData.get("image") as File;
          const userId = formData.get("userId") as string | null;
          const tasteGroupId = formData.get("tasteGroupId") as string | null;
          const uploadId = formData.get("uploadId") as string | null;
          
          if (!imageFile) {
            return new Response(JSON.stringify({ error: "No image provided" }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          // Validate file type and size
          if (!imageFile.type.startsWith('image/')) {
            return new Response(JSON.stringify({ error: "Invalid file type. Please upload an image." }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          if (imageFile.size > 10 * 1024 * 1024) { // 10MB limit
            return new Response(JSON.stringify({ error: "File too large. Maximum size is 10MB." }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÎßå Î∂ÑÏÑù Í∞ÄÎä• (ÏÑ†ÌÉùÏ†Å)
          if (userId) {
            const uploadLimit = await AuthAPI.checkUploadLimit(userId);
            if (!uploadLimit.canUpload) {
              return new Response(JSON.stringify({ 
                error: "ÏùºÏùº Î∂ÑÏÑù Ï†úÌïúÏóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§.",
                resetTime: uploadLimit.resetTime
              }), {
                status: 429,
                headers: { "Content-Type": "application/json" }
              });
            }
          }

          console.log(`üîç Analyzing image: ${imageFile.name} (${imageFile.size} bytes)`);

          // Convert file to buffer for AI analysis
          const imageBuffer = Buffer.from(await imageFile.arrayBuffer());

          // Perform AI analysis and get recommendations
          const result = await getAIService().analyzeImageAndRecommend(
            imageBuffer,
            userId || undefined,
            tasteGroupId || undefined,
            10 // limit
          );

          // Î∂ÑÏÑù Í≤∞Í≥ºÎ•º ÏóÖÎ°úÎìú Í∏∞Î°ùÏóê ÏóÖÎç∞Ïù¥Ìä∏ (ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏Ïù∏Ìïú Í≤ΩÏö∞)
          if (userId && uploadId) {
            const { supabase } = await import('./services/supabase');
            if (supabase) {
              const { error: updateError } = await supabase
                .from('user_uploads')
                .update({
                  analysis_keywords: result.analysis.keywords,
                  analysis_embeddings: result.analysis.embeddings || null,
                })
                .eq('id', uploadId)
                .eq('user_id', userId);

              if (updateError) {
                console.error('Failed to update upload record:', updateError);
              }

              // Ï∂îÏ≤ú Í≤∞Í≥ºÎèÑ Ï†ÄÏû•
              if (result.recommendations.length > 0) {
                const recommendations = result.recommendations.map(rec => ({
                  user_id: userId,
                  upload_id: uploadId,
                  artwork_id: rec.id,
                  similarity_score: rec.similarity,
                  reasoning: rec.reasoning || []
                }));

                const { error: recError } = await supabase
                  .from('recommendations')
                  .insert(recommendations);

                if (recError) {
                  console.error('Failed to save recommendations:', recError);
                }
              }

              // Î∂ÑÏÑù Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
              await AuthAPI.incrementUploadCount(userId);
              
              // ÏÇ¨Ïö©Îüâ Î∂ÑÏÑù Í∏∞Î°ù
              await AnalyticsService.recordUsage(userId, 'image_analysis');
              await AnalyticsService.recordUsage(userId, 'recommendation');
            }
          }

          return new Response(JSON.stringify({
            status: "success",
            image_size: imageFile.size,
            image_type: imageFile.type,
            processing_time: result.processingTime,
            recommendations: result.recommendations,
            analysis: {
              keywords: result.analysis.keywords,
              colors: result.analysis.colors,
              style: result.analysis.style,
              mood: result.analysis.mood,
              confidence: result.analysis.confidence
            }
          }), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error("‚ùå Analysis error:", error);
          return new Response(JSON.stringify({ 
            error: "Analysis failed",
            message: error instanceof Error ? error.message : "Unknown error",
            status: "error"
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/artworks": {
      GET: async () => {
        try {
          const { data: artworks, error } = await supabase
            .from('artworks')
            .select('*')
            .eq('available', true)
            .order('created_at', { ascending: false })
            .limit(50);

          if (error) {
            console.error('Database error:', error);
            // Fallback to mock data if database is not ready
            const mockArtworks = [
              {
                id: "1",
                title: "Î™®ÎÇòÎ¶¨Ïûê",
                artist: "Î†àÏò§ÎÇòÎ•¥ÎèÑ Îã§ ÎπàÏπò",
                image_url: "https://via.placeholder.com/300x300?text=Mona+Lisa",
                keywords: ["portrait", "renaissance", "classical"],
                created_at: "2024-01-01T00:00:00Z"
              }
            ];
            return new Response(JSON.stringify({ artworks: mockArtworks }), {
              headers: { "Content-Type": "application/json" }
            });
          }

          return new Response(JSON.stringify({ artworks: artworks || [] }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Artworks API error:', error);
          return new Response(JSON.stringify({ 
            error: "Failed to fetch artworks",
            artworks: [] 
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/signup": {
      POST: async (req) => {
        try {
          const { email, password, displayName } = await req.json();
          
          if (!email || !password) {
            return new Response(JSON.stringify({ 
              success: false, 
              error: "Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AuthAPI.signUp(email, password, displayName);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Signup error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌöåÏõêÍ∞ÄÏûÖ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/signin": {
      POST: async (req) => {
        try {
          const { email, password } = await req.json();
          
          if (!email || !password) {
            return new Response(JSON.stringify({ 
              success: false, 
              error: "Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AuthAPI.signIn(email, password);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Signin error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/signout": {
      POST: async () => {
        try {
          const result = await AuthAPI.signOut();
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Signout error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/user": {
      GET: async () => {
        try {
          const result = await AuthAPI.getCurrentUser();
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 401,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get user error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/profile": {
      PUT: async (req) => {
        try {
          const { userId, displayName, avatarUrl } = await req.json();
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false, 
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const updates: { display_name?: string; avatar_url?: string } = {};
          if (displayName) updates.display_name = displayName;
          if (avatarUrl) updates.avatar_url = avatarUrl;

          const result = await AuthAPI.updateProfile(userId, updates);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Update profile error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌîÑÎ°úÌïÑ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/auth/upload-limit": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              canUpload: false, 
              remainingUploads: 0,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AuthAPI.checkUploadLimit(userId);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Upload limit check error:', error);
          return new Response(JSON.stringify({
            canUpload: true,
            remainingUploads: 10,
            error: "ÏóÖÎ°úÎìú Ï†úÌïú ÌôïÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/upload": {
      POST: async (req) => {
        try {
          const formData = await req.formData();
          const imageFile = formData.get("image") as File;
          const userId = formData.get("userId") as string;
          
          if (!imageFile || !userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Ïù¥ÎØ∏ÏßÄ ÌååÏùºÍ≥º ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          // ÌååÏùº Ïú†Ìòï Î∞è ÌÅ¨Í∏∞ Í≤ÄÏ¶ù
          if (!imageFile.type.startsWith('image/')) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          if (imageFile.size > 10 * 1024 * 1024) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌååÏùº ÌÅ¨Í∏∞Îäî 10MBÎ•º Ï¥àÍ≥ºÌï† Ïàò ÏóÜÏäµÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          // ÏóÖÎ°úÎìú Ï†úÌïú ÌôïÏù∏
          const uploadLimit = await AuthAPI.checkUploadLimit(userId);
          if (!uploadLimit.canUpload) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏùºÏùº ÏóÖÎ°úÎìú Ï†úÌïúÏóê ÎèÑÎã¨ÌñàÏäµÎãàÎã§.",
              resetTime: uploadLimit.resetTime
            }), {
              status: 429,
              headers: { "Content-Type": "application/json" }
            });
          }

          // ÌååÏùº ÏóÖÎ°úÎìú Í≤ΩÎ°ú ÏÉùÏÑ±
          const fileExt = imageFile.name.split('.').pop();
          const fileName = `${userId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;

          // Supabase StorageÏóê ÏóÖÎ°úÎìú
          const { storage } = await import('../services/supabase');
          const uploadResult = await storage.uploadImage(imageFile, fileName);

          if (uploadResult.error) {
            console.error('Image upload failed:', uploadResult.error);
            return new Response(JSON.stringify({ 
              success: false,
              error: "Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§." 
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          // ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ URL ÏÉùÏÑ±
          const imageUrl = storage.getImageUrl(fileName);

          // ÏÇ¨Ïö©Ïûê ÏóÖÎ°úÎìú Í∏∞Î°ù Ï†ÄÏû•
          const { supabase } = await import('../services/supabase');
          if (supabase) {
            const { data: uploadRecord, error: dbError } = await supabase
              .from('user_uploads')
              .insert({
                user_id: userId,
                image_url: imageUrl,
                analysis_keywords: [], // AI Î∂ÑÏÑù ÌõÑ ÏóÖÎç∞Ïù¥Ìä∏Îê®
              })
              .select()
              .single();

            if (dbError) {
              console.error('Failed to save upload record:', dbError);
            }

            // ÏóÖÎ°úÎìú Ïπ¥Ïö¥Ìä∏ Ï¶ùÍ∞Ä
            await AuthAPI.incrementUploadCount(userId);
          }

          return new Response(JSON.stringify({ 
            success: true,
            imageUrl,
            fileName,
            message: "Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§."
          }), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Upload error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/uploads": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const { supabase } = await import('./services/supabase');
          if (!supabase) {
            return new Response(JSON.stringify({ 
              success: false,
              uploads: [],
              error: "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Íµ¨ÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            }), {
              headers: { "Content-Type": "application/json" }
            });
          }

          const { data: uploads, error } = await supabase
            .from('user_uploads')
            .select('*')
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(limit);

          if (error) {
            console.error('Failed to fetch uploads:', error);
            return new Response(JSON.stringify({ 
              success: false,
              uploads: [],
              error: "ÏóÖÎ°úÎìú Í∏∞Î°ù Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          return new Response(JSON.stringify({ 
            success: true,
            uploads: uploads || []
          }), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Fetch uploads error:', error);
          return new Response(JSON.stringify({
            success: false,
            uploads: [],
            error: "ÏóÖÎ°úÎìú Í∏∞Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/recommendations": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const uploadId = url.searchParams.get('uploadId');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const { supabase } = await import('./services/supabase');
          if (!supabase) {
            return new Response(JSON.stringify({ 
              success: false,
              recommendations: [],
              error: "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Íµ¨ÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            }), {
              headers: { "Content-Type": "application/json" }
            });
          }

          // Ï∂îÏ≤ú Í∏∞Î°ùÏùÑ ÏûëÌíà Ï†ïÎ≥¥ÏôÄ Ìï®Íªò Ï°∞Ìöå
          let query = supabase
            .from('recommendations')
            .select(`
              *,
              artworks (
                id,
                title,
                artist,
                image_url,
                thumbnail_url,
                description,
                keywords,
                price,
                available
              ),
              user_uploads (
                id,
                image_url,
                analysis_keywords,
                created_at
              )
            `)
            .eq('user_id', userId)
            .order('created_at', { ascending: false })
            .limit(limit);

          // ÌäπÏ†ï ÏóÖÎ°úÎìúÏóê ÎåÄÌïú Ï∂îÏ≤úÎßå Ï°∞Ìöå
          if (uploadId) {
            query = query.eq('upload_id', uploadId);
          }

          const { data: recommendations, error } = await query;

          if (error) {
            console.error('Failed to fetch recommendations:', error);
            return new Response(JSON.stringify({ 
              success: false,
              recommendations: [],
              error: "Ï∂îÏ≤ú Í∏∞Î°ù Ï°∞ÌöåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          return new Response(JSON.stringify({ 
            success: true,
            recommendations: recommendations || []
          }), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Fetch recommendations error:', error);
          return new Response(JSON.stringify({
            success: false,
            recommendations: [],
            error: "Ï∂îÏ≤ú Í∏∞Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/recommendations/click": {
      POST: async (req) => {
        try {
          const { recommendationId, userId } = await req.json();
          
          if (!recommendationId || !userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Ï∂îÏ≤ú IDÏôÄ ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const { supabase } = await import('./services/supabase');
          if (!supabase) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Íµ¨ÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          const { error } = await supabase
            .from('recommendations')
            .update({
              clicked: true,
              clicked_at: new Date().toISOString()
            })
            .eq('id', recommendationId)
            .eq('user_id', userId);

          if (error) {
            console.error('Failed to update recommendation click:', error);
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌÅ¥Î¶≠ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§."
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          return new Response(JSON.stringify({ 
            success: true,
            message: "ÌÅ¥Î¶≠ Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."
          }), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Update recommendation click error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌÅ¥Î¶≠ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // Í≥†Í∏â Í∞úÏù∏Ìôî Ï∂îÏ≤ú API (V2)
    "/api/v2/recommendations": {
      POST: async (req) => {
        try {
          const request = await req.json();
          const result = await getRecommendationsV2API().getPersonalizedRecommendations(request);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('V2 Recommendations error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Í∞úÏù∏Ìôî Ï∂îÏ≤ú ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/v2/interactions": {
      POST: async (req) => {
        try {
          const { userId, artworkId, interactionType } = await req.json();
          
          if (!userId || !artworkId || !interactionType) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getRecommendationsV2API().recordInteraction(userId, artworkId, interactionType);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Record interaction error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÉÅÌò∏ÏûëÏö© Í∏∞Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/v2/recommendations/realtime": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const currentRecs = url.searchParams.get('currentRecommendations')?.split(',') || [];
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getRecommendationsV2API().getRealtimeRecommendationUpdates(userId, currentRecs);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Realtime recommendations error:', error);
          return new Response(JSON.stringify({
            updated: false,
            error: "Ïã§ÏãúÍ∞Ñ Ï∂îÏ≤ú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/v2/analytics/recommendations": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const period = parseInt(url.searchParams.get('period') || '30');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getRecommendationsV2API().getRecommendationAnalytics(userId, period);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Recommendation analytics error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ï∂îÏ≤ú Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // ÏÜåÏÖú Í∏∞Îä• API
    "/api/social/share": {
      POST: async (req) => {
        try {
          const { userId, artworkId, ...shareData } = await req.json();
          
          if (!userId || !artworkId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ ÏûëÌíà IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().shareArtwork(userId, artworkId, shareData);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Share artwork error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏûëÌíà Í≥µÏú† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/review": {
      POST: async (req) => {
        try {
          const { userId, artworkId, ...reviewData } = await req.json();
          
          if (!userId || !artworkId || !reviewData.rating || !reviewData.title || !reviewData.content) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().createReview(userId, artworkId, reviewData);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Create review error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Î¶¨Î∑∞ ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/follow": {
      POST: async (req) => {
        try {
          const { followerId, followingId } = await req.json();
          
          if (!followerId || !followingId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌåîÎ°úÏõå IDÏôÄ ÌåîÎ°úÏûâ IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().followUser(followerId, followingId);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Follow user error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌåîÎ°úÏö∞ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/interact": {
      POST: async (req) => {
        try {
          const { userId, targetType, targetId, interactionType, metadata } = await req.json();
          
          if (!userId || !targetType || !targetId || !interactionType) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().addInteraction(
            userId, targetType, targetId, interactionType, metadata
          );
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Add interaction error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÉÅÌò∏ÏûëÏö© Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/comment": {
      POST: async (req) => {
        try {
          const { userId, targetType, targetId, content, parentCommentId } = await req.json();
          
          if (!userId || !targetType || !targetId || !content) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().addComment(
            userId, targetType, targetId, content, parentCommentId
          );
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Add comment error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÎåìÍ∏Ä ÏûëÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/feed": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          const offset = parseInt(url.searchParams.get('offset') || '0');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().getPersonalizedFeed(userId, limit, offset);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get feed error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌîºÎìú Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/profile/:userId": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const targetUserId = req.params?.userId || url.pathname.split('/').pop();
          const requestingUserId = url.searchParams.get('requestingUserId');
          
          if (!targetUserId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§." 
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getSocialFeaturesService().getUserSocialProfile(targetUserId, requestingUserId);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get social profile error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌîÑÎ°úÌïÑ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/social/trending": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const period = url.searchParams.get('period') as 'day' | 'week' | 'month' || 'week';
          const limit = parseInt(url.searchParams.get('limit') || '20');

          const result = await getSocialFeaturesService().getTrendingContent(period, limit);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get trending content error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ìä∏Î†åÎî© ÏΩòÌÖêÏ∏† Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // AI ÏÑ±Îä• Î™®ÎãàÌÑ∞ÎßÅ API
    "/api/ai/performance": {
      GET: async () => {
        try {
          const metrics = getAIService().getPerformanceMetrics();
          return new Response(JSON.stringify({
            success: true,
            metrics
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get performance metrics error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÑ±Îä• ÏßÄÌëú Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/ai/optimization/config": {
      PUT: async (req) => {
        try {
          const config = await req.json();
          getAIService().updateOptimizationConfig(config);
          
          return new Response(JSON.stringify({
            success: true,
            message: "ÏµúÏ†ÅÌôî ÏÑ§Ï†ïÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§."
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Update optimization config error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/ai/cache/clear": {
      POST: async () => {
        try {
          getAIService().clearPerformanceCache();
          
          return new Response(JSON.stringify({
            success: true,
            message: "Ï∫êÏãúÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§."
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Clear cache error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ï∫êÏãú ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/plans": {
      GET: async () => {
        try {
          return new Response(JSON.stringify({
            success: true,
            plans: SUBSCRIPTION_PLANS,
            stripeConfigured: StripeService.isConfigured(),
          }), {
            headers: { "Content-Type": "application/json" }
          });
        } catch (error) {
          console.error('Get plans error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏöîÍ∏àÏ†ú Ï†ïÎ≥¥ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/create": {
      POST: async (req) => {
        try {
          const { userId, planId, paymentMethodId } = await req.json();
          
          if (!userId || !planId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ ÏöîÍ∏àÏ†úÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          if (!StripeService.isConfigured()) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í≤∞Ï†ú ÏãúÏä§ÌÖúÏù¥ Íµ¨ÏÑ±ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§."
            }), {
              status: 500,
              headers: { "Content-Type": "application/json" }
            });
          }

          // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï°∞Ìöå
          const { data: user } = await supabase
            ?.from('users')
            .select('email, display_name')
            .eq('id', userId)
            .single() || { data: null };

          if (!user) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
            }), {
              status: 404,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await StripeService.createSubscription(
            userId, 
            user.email, 
            planId,
            paymentMethodId
          );

          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Create subscription error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨ÎèÖ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/cancel": {
      POST: async (req) => {
        try {
          const { userId, subscriptionId } = await req.json();
          
          if (!userId || !subscriptionId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ Íµ¨ÎèÖ IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await StripeService.cancelSubscription(userId, subscriptionId);

          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Cancel subscription error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨ÎèÖ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/resume": {
      POST: async (req) => {
        try {
          const { userId, subscriptionId } = await req.json();
          
          if (!userId || !subscriptionId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ Íµ¨ÎèÖ IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await StripeService.resumeSubscription(userId, subscriptionId);

          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Resume subscription error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨ÎèÖ Ïû¨Í∞ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/status": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await StripeService.getUserSubscription(userId);

          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get subscription status error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨ÎèÖ ÏÉÅÌÉú Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/subscription/portal": {
      POST: async (req) => {
        try {
          const { userId, returnUrl } = await req.json();
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await StripeService.createPortalSession(
            userId, 
            returnUrl || `${req.headers.get('origin') || 'http://localhost:3000'}/profile`
          );

          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Create portal session error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ìè¨ÌÑ∏ ÏÑ∏ÏÖò ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/webhook/stripe": {
      POST: async (req) => {
        try {
          const body = await req.text();
          const signature = req.headers.get('stripe-signature');
          
          if (!signature) {
            return new Response('Missing stripe-signature header', { status: 400 });
          }

          const result = await StripeService.handleWebhook(body, signature);

          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Stripe webhook error:', error);
          return new Response('Webhook processing failed', { status: 500 });
        }
      }
    },

    // Admin API endpoints
    "/api/admin/stats/users": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.getUserStats();
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get user stats error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/admin/stats/usage": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.getUsageStats();
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get usage stats error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÇ¨Ïö©Îüâ ÌÜµÍ≥Ñ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/admin/activity": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.getRecentActivity();
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get recent activity error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏµúÍ∑º ÌôúÎèô Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/admin/artworks": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const page = parseInt(url.searchParams.get('page') || '1');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.getArtworks(page, limit);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get artworks error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏûëÌíà Î™©Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      },

      POST: async (req) => {
        try {
          const { userId, ...artworkData } = await req.json();
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.createArtwork({
            ...artworkData,
            admin_user_id: userId
          });
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Create artwork error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏûëÌíà ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/admin/artworks/:id": {
      PUT: async (req) => {
        try {
          const url = new URL(req.url);
          const artworkId = url.pathname.split('/').pop();
          const { userId, ...updates } = await req.json();
          
          if (!userId || !artworkId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ ÏûëÌíà IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.updateArtwork(artworkId, updates);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Update artwork error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏûëÌíà ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      },

      DELETE: async (req) => {
        try {
          const url = new URL(req.url);
          const artworkId = url.pathname.split('/').pop();
          const userId = url.searchParams.get('userId');
          
          if (!userId || !artworkId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÏôÄ ÏûëÌíà IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AdminAPI.deleteArtwork(artworkId);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Delete artwork error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏûëÌíà ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // Analytics API endpoints
    "/api/analytics/user": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const days = parseInt(url.searchParams.get('days') || '30');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AnalyticsService.getUserUsageStats(userId, days);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get user analytics error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏÇ¨Ïö©Ïûê Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/analytics/system": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const days = parseInt(url.searchParams.get('days') || '30');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await AnalyticsService.getSystemUsageStats(days);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get system analytics error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÏãúÏä§ÌÖú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/analytics/recommendations": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const adminUserId = url.searchParams.get('adminUserId');
          
          // Í¥ÄÎ¶¨ÏûêÍ∞Ä Ï†ÑÏ≤¥ Ï∂îÏ≤ú Î∂ÑÏÑùÏùÑ Î≥¥Î†§Îäî Í≤ΩÏö∞
          if (adminUserId) {
            const isAdmin = await AdminAPI.isAdmin(adminUserId);
            if (!isAdmin) {
              return new Response(JSON.stringify({ 
                success: false,
                error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
              }), {
                status: 403,
                headers: { "Content-Type": "application/json" }
              });
            }
          }

          const result = await AnalyticsService.getRecommendationAnalytics(adminUserId ? undefined : userId);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get recommendation analytics error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Ï∂îÏ≤ú Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // Purchase Request API endpoints
    "/api/purchase/request": {
      POST: async (req) => {
        try {
          const { artworkId, userId, contactInfo, urgency } = await req.json();
          
          if (!artworkId || !userId || !contactInfo) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          if (!contactInfo.name || !contactInfo.phone) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Ïó∞ÎùΩÏ≤ò Ï†ïÎ≥¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await PurchaseAPI.createPurchaseRequest(
            artworkId, 
            userId, 
            contactInfo, 
            urgency || 'medium'
          );
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Create purchase request error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨Îß§ ÏöîÏ≤≠ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/purchase/requests": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await PurchaseAPI.getUserPurchaseRequests(userId);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get purchase requests error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨Îß§ ÏöîÏ≤≠ Î™©Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/purchase/requests/:id/cancel": {
      POST: async (req) => {
        try {
          const url = new URL(req.url);
          const requestId = url.pathname.split('/')[4]; // /api/purchase/requests/:id/cancel
          const { userId, reason } = await req.json();
          
          if (!requestId || !userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await PurchaseAPI.cancelPurchaseRequest(requestId, userId, reason);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Cancel purchase request error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨Îß§ ÏöîÏ≤≠ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // Admin Purchase Management endpoints
    "/api/admin/purchase/requests": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const page = parseInt(url.searchParams.get('page') || '1');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          const status = url.searchParams.get('status') || undefined;
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 401,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await PurchaseAPI.getAllPurchaseRequests(page, limit, status);
          
          return new Response(JSON.stringify(result), {
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Get all purchase requests error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨Îß§ ÏöîÏ≤≠ Î™©Î°ù Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/admin/purchase/requests/:id/status": {
      PUT: async (req) => {
        try {
          const url = new URL(req.url);
          const requestId = url.pathname.split('/')[5]; // /api/admin/purchase/requests/:id/status
          const { userId, status, adminNote, finalPrice } = await req.json();
          
          if (!requestId || !userId || !status) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÌïÑÏàò Ï†ïÎ≥¥Í∞Ä ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const isAdmin = await AdminAPI.isAdmin(userId);
          if (!isAdmin) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 403,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await PurchaseAPI.updatePurchaseRequestStatus(
            requestId,
            status,
            userId,
            adminNote,
            finalPrice
          );
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Update purchase request status error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Íµ¨Îß§ ÏöîÏ≤≠ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    // Multi-Image Analysis API endpoints
    "/api/multi-image/analyze": {
      POST: async (req) => {
        return await getMultiImageAPI().analyzeMultipleImages(req);
      }
    },

    "/api/multi-image/history": {
      GET: async (req) => {
        try {
          const url = new URL(req.url);
          const userId = url.searchParams.get('userId');
          const limit = parseInt(url.searchParams.get('limit') || '20');
          
          if (!userId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÇ¨Ïö©Ïûê IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          return await getMultiImageAPI().getUserAnalysisHistory(userId, limit);

        } catch (error) {
          console.error('Get multi-image history error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "ÌûàÏä§ÌÜ†Î¶¨ Ï°∞Ìöå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/multi-image/payment-success": {
      POST: async (req) => {
        try {
          const { sessionId } = await req.json();
          
          if (!sessionId) {
            return new Response(JSON.stringify({ 
              success: false,
              error: "ÏÑ∏ÏÖò IDÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."
            }), {
              status: 400,
              headers: { "Content-Type": "application/json" }
            });
          }

          const result = await getMultiImageAPI().handlePaymentSuccess(sessionId);
          
          return new Response(JSON.stringify(result), {
            status: result.success ? 200 : 400,
            headers: { "Content-Type": "application/json" }
          });

        } catch (error) {
          console.error('Multi-image payment success error:', error);
          return new Response(JSON.stringify({
            success: false,
            error: "Í≤∞Ï†ú Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."
          }), {
            status: 500,
            headers: { "Content-Type": "application/json" }
          });
        }
      }
    },

    "/api/search/external": {
      POST: async (req) => {
        return await getMultiImageAPI().searchExternalPlatforms(req);
      }
    }
  },

  // WebSocket ÏßÄÏõê
  websocket: {
    open(ws) {
      console.log("WebSocket connection opened");
      ws.send(JSON.stringify({ 
        type: "connection", 
        message: "Connected to AI Art Recommendation service",
        timestamp: Date.now()
      }));
    },

    message(ws, message) {
      console.log("WebSocket message received:", message);
      
      try {
        const data = JSON.parse(message.toString()) as WebSocketData;
        
        // Echo back with timestamp
        ws.send(JSON.stringify({
          type: "echo",
          originalMessage: data.message,
          serverTimestamp: Date.now(),
          clientTimestamp: data.timestamp
        }));
      } catch (error) {
        ws.send(JSON.stringify({
          type: "error",
          message: "Invalid JSON format",
          timestamp: Date.now()
        }));
      }
    },

    close(ws, code, message) {
      console.log("WebSocket connection closed:", code, message);
    }
  },

  error(error) {
    console.error("Server error:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
});

console.log(`üöÄ AI Art Recommendation Server running at http://localhost:${server.port}`);
console.log(`üì± WebSocket endpoint: ws://localhost:${server.port}`);
console.log(`üé® Frontend: http://localhost:${server.port}`);
console.log(`‚ù§Ô∏è  Health check: http://localhost:${server.port}/api/health`);
console.log(`üîê Authentication: Login/Signup available`);