<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Art Recommendation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PayPal SDK with Live Credentials -->
    <script src="https://www.paypal.com/sdk/js?client-id=AZb37RpQo5rEjg4CdahNsQ2qUm6UrQwivySQ-AxvKqszkUtzGu39Hje2XtpfvKEr9KDBZgYx8EBN5Hv_&currency=USD"></script>
    <style>
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <div id="root" class="min-h-screen">
        <!-- Loading placeholder -->
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
                AI Art Recommendation
            </h1>
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>

    <!-- Simple JavaScript implementation instead of React -->
    <script>
        console.log('ğŸš€ AI Art Recommendation App loaded');
        
        let currentUser = null;
        let viewMode = 'single';
        
        // ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ ëª¨ë“œë¡œ ì „í™˜í•˜ëŠ” í•¨ìˆ˜
        function goToAnalyzePage() {
            console.log('ğŸ¤– ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ ëª¨ë“œë¡œ ì „í™˜...');
            setViewMode('single');
        }
        
        function checkAuthStatus() {
            try {
                const auth = localStorage.getItem('auth');
                if (auth) {
                    const authData = JSON.parse(auth);
                    if (authData.isLoggedIn && authData.user) {
                        currentUser = authData.user;
                        console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', authData.user.email);
                        return authData;
                    }
                }
            } catch (error) {
                console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                localStorage.removeItem('auth');
            }
            return null;
        }

        function logout() {
            localStorage.removeItem('auth');
            currentUser = null;
            window.location.reload();
        }

        function initializeApp() {
            console.log('ğŸ“ Initializing app');
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            const authData = checkAuthStatus();
            
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-sm border-b">
                        <div class="container mx-auto px-4 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <h1 class="text-lg sm:text-2xl font-bold text-gray-800">AI Art</h1>
                                <div class="flex items-center">
                                    ${authData ? `
                                        <div class="flex items-center space-x-2">
                                            <span class="hidden sm:inline text-sm text-gray-600">ì•ˆë…•í•˜ì„¸ìš”, ${authData.profile?.display_name || authData.user.email}ë‹˜!</span>
                                            <div class="dropdown relative">
                                                <button class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md text-sm">
                                                    <span class="sm:hidden">ë©”ë‰´</span>
                                                    <span class="hidden sm:inline">ë‚´ ê³„ì •</span>
                                                </button>
                                                <div class="dropdown-content hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                    <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">í”„ë¡œí•„</a>
                                                    <a href="/social" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ì†Œì…œ</a>
                                                    <hr class="my-1">
                                                    <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">ë¡œê·¸ì•„ì›ƒ</button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="flex items-center space-x-2">
                                            <a href="/auth" class="text-gray-600 hover:text-gray-800 px-2 sm:px-3 py-1 sm:py-2 text-sm">ë¡œê·¸ì¸</a>
                                            <a href="/auth" class="bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-md text-sm">íšŒì›ê°€ì…</a>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="container mx-auto px-4 py-8">
                        <div class="max-w-4xl mx-auto space-y-8">
                            <!-- Mode Selector -->
                            <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4">
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    <button onclick="setViewMode('single')" id="singleBtn" class="px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base">
                                        <span class="block sm:hidden">ë‹¨ì¼ ë¶„ì„</span>
                                        <span class="hidden sm:block">ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„</span>
                                    </button>
                                    <button onclick="setViewMode('multi')" id="multiBtn" class="px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base">
                                        <span class="block sm:hidden">ë‹¤ì¤‘ ë¶„ì„</span>
                                        <span class="hidden sm:block">ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¶„ì„</span>
                                    </button>
                                    <button onclick="alert('AI ê°œì¸í™” ì¶”ì²œì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤')" class="col-span-2 sm:col-span-1 px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base">
                                        <span class="block sm:hidden">ğŸ¤– AI ì¶”ì²œ</span>
                                        <span class="hidden sm:block">ğŸ¤– AI ê°œì¸í™” ì¶”ì²œ</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Content Area -->
                            <div id="contentArea">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            // Initialize with single mode
            setViewMode('single');
        }
        
        function setViewMode(mode) {
            console.log('ğŸ”„ Setting view mode:', mode);
            viewMode = mode;
            
            // Update button styles with responsive classes
            const buttons = ['singleBtn', 'multiBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (btnId === mode + 'Btn') {
                        btn.className = 'px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                    } else {
                        btn.className = 'px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base';
                    }
                }
            });
            
            // Load content based on mode
            const contentArea = document.getElementById('contentArea');
            if (mode === 'single') {
                contentArea.innerHTML = getSingleImageHTML();
                // ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
                setTimeout(initSingleImageUpload, 50);
            } else if (mode === 'multi') {
                contentArea.innerHTML = getMultiImageHTML();
                initMultiImageUpload();
            }
        }
        
        
        function getSingleImageHTML() {
            return '<div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">' +
                '<h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4">ğŸ¤– ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„</h2>' +
                '<p class="text-sm sm:text-base text-gray-600">AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ìŠ¤íƒ€ì¼, ìƒ‰ìƒ, ë¶„ìœ„ê¸°ë¥¼ íŒŒì•…í•˜ê³  ìœ ì‚¬í•œ ì‘í’ˆì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.</p>' +
                
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­
                '<div id="singleUploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 sm:p-8 text-center hover:border-blue-400 transition-colors cursor-pointer mt-2" onclick="document.getElementById(\'singleImageInput\').click()">' +
                '<div id="singleUploadContent">' +
                '<div class="text-3xl sm:text-4xl mb-2">ğŸ¨</div>' +
                '<p class="text-sm sm:text-base text-gray-500 mb-2 sm:mb-4">ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜<br class="hidden sm:block"><span class="sm:hidden"> </span>ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>' +
                '<p class="text-xs sm:text-sm text-gray-400">JPG, PNG, GIF ì§€ì› (ìµœëŒ€ 10MB)</p>' +
                '</div>' +
                '</div>' +
                '<input type="file" id="singleImageInput" accept="image/*" style="display: none;">' +
                
                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
                '<div id="singleImagePreview" style="display: none;" class="mt-4">' +
                '<div class="relative group">' +
                '<img id="singlePreviewImg" src="" alt="Preview" class="w-full max-h-64 object-contain rounded-lg shadow-lg mx-auto">' +
                '</div>' +
                '<p id="singleImageInfo" class="text-sm text-gray-600 mt-2 text-center"></p>' +
                '<div class="flex gap-3 mt-4">' +
                '<button id="singleChangeBtn" onclick="document.getElementById(\'singleImageInput\').click()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">ìƒˆ ì´ë¯¸ì§€ ì„ íƒ</button>' +
                '<button id="singleRemoveBtn" onclick="clearSingleImage()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">ì‚­ì œ</button>' +
                '</div>' +
                '<button id="singleAnalyzeBtn" onclick="analyzeSingleImage()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all mt-4 shadow-lg">âœ¨ AI ë¶„ì„ ì‹œì‘</button>' +
                '</div>' +
                
                // ë¡œë”© ìƒíƒœ
                '<div id="singleLoading" style="display: none;" class="mt-4 text-center">' +
                '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>' +
                '<p class="text-gray-600">AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>' +
                '</div>' +
                
                // ì—ëŸ¬ ë©”ì‹œì§€
                '<div id="singleError" style="display: none;" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">' +
                '<p id="singleErrorText" class="text-red-700"></p>' +
                '</div>' +
                
                // ë¶„ì„ ê²°ê³¼
                '<div id="singleResult" style="display: none;" class="mt-6">' +
                '<h3 class="text-lg font-bold mb-4">ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>' +
                '<div id="singleAnalysisDetails"></div>' +
                '<div id="singleRecommendations"></div>' +
                '</div>' +
                
                '</div>';
        }
        
        // AI Generator removed
        
        function getMultiImageHTML() {
            var html = '';
            html += '<div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 md:p-8">';
            html += '<h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-4 sm:mb-6">ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¶„ì„</h2>';
            
            // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ì•ˆë‚´
            html += '<div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-green-50 border border-green-200 rounded-lg">';
            html += '<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">';
            html += '<div>';
            html += '<p class="text-xs sm:text-sm text-green-800">';
            html += '<strong>ğŸ‰ ê²ŒìŠ¤íŠ¸ ëª¨ë“œ:</strong> ë¡œê·¸ì¸ ì—†ì´ë„ ìµœëŒ€ 3ì¥ê¹Œì§€ ë¬´ë£Œë¡œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
            html += '</p>';
            html += '<p class="text-xs text-green-600 mt-1">';
            html += 'ğŸ’¡ 4ì¥ ì´ìƒ ë¶„ì„í•˜ë ¤ë©´ ë¡œê·¸ì¸ í›„ ê²°ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.';
            html += '</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // ê°€ê²© ì •ë³´
            html += '<div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-blue-50 rounded-lg">';
            html += '<h3 class="font-semibold mb-2 text-sm sm:text-base">ê°€ê²© ì•ˆë‚´</h3>';
            html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4 text-xs sm:text-sm">';
            html += '<div class="p-2 rounded bg-blue-100 font-semibold">';
            html += '<div>ë¬´ë£Œ</div>';
            html += '<div class="text-gray-600">ìµœëŒ€ 3ì¥</div>';
            html += '<div class="text-xs text-green-600 mt-1">ê²ŒìŠ¤íŠ¸ ê°€ëŠ¥</div>';
            html += '</div>';
            html += '<div class="p-2 rounded">'; 
            html += '<div>$5</div>';
            html += '<div class="text-gray-600">4-10ì¥</div>';
            html += '<div class="text-xs text-red-600 mt-1">ë¡œê·¸ì¸ í•„ìš”</div>';
            html += '</div>';
            html += '<div class="p-2 rounded">';
            html += '<div>$10</div>';
            html += '<div class="text-gray-600">11ì¥ ì´ìƒ</div>';
            html += '<div class="text-xs text-red-600 mt-1">ë¡œê·¸ì¸ í•„ìš”</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ
            html += '<div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-gray-400 transition-colors" onclick="document.getElementById(\'multiImageInput\').click()">';
            html += '<svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>';
            html += '</svg>';
            html += '<p class="text-gray-600">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>';
            html += '<p class="text-sm text-gray-500 mt-2">ìµœëŒ€ 50ì¥, ê° 10MB ì´í•˜</p>';
            html += '</div>';
            html += '<input type="file" id="multiImageInput" multiple accept="image/*" style="display: none;">';
            
            // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
            html += '<div id="imagePreview" style="display: none;">';
            html += '<div class="mt-6">';
            html += '<h3 class="font-semibold mb-4">ì—…ë¡œë“œëœ ì´ë¯¸ì§€ (<span id="imageCount">0</span>ì¥)</h3>';
            html += '<div id="imageGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>';
            html += '</div>';
            html += '</div>';
            
            // ì—ëŸ¬ ë©”ì‹œì§€
            html += '<div id="multiError" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg" style="display: none;">';
            html += '<div class="flex items-center">';
            html += '<svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">';
            html += '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>';
            html += '</svg>';
            html += '<span id="multiErrorText" class="text-red-700"></span>';
            html += '</div>';
            html += '</div>';

            // ë¶„ì„ ë²„íŠ¼
            html += '<div class="mt-6 flex flex-col items-center space-y-4">';
            html += '<button id="analyzeMultiBtn" onclick="analyzeMultipleImages()" disabled class="px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed">';
            html += 'ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
            html += '</button>';
            html += '</div>';
            
            // ë¶„ì„ ê²°ê³¼
            html += '<div id="multiResult" style="display: none;" class="mt-8 bg-white rounded-lg shadow-lg p-8">';
            html += '<h3 class="text-xl font-bold mb-4">ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</h3>';
            html += '<div id="multiResultContent"></div>';
            html += '</div>';
            html += '</div>';
            
            return html;
        }
        
        let selectedImages = [];
        
        function initMultiImageUpload() {
            const input = document.getElementById('multiImageInput');
            if (input) {
                input.addEventListener('change', handleImageSelection);
            }
        }
        
        function handleImageSelection(event) {
            console.log('ğŸ“¸ Images selected');
            selectedImages = Array.from(event.target.files);
            updateImagePreview();
            updateAnalyzeButton();
        }
        
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            const grid = document.getElementById('imageGrid');
            const count = document.getElementById('imageCount');
            
            if (selectedImages.length > 0) {
                preview.style.display = 'block';
                count.textContent = selectedImages.length;
                
                grid.innerHTML = '';
                selectedImages.forEach((file, index) => {
                    const url = URL.createObjectURL(file);
                    const div = document.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = 
                        '<img src="' + url + '" alt="' + file.name + '" class="w-full h-24 object-cover rounded-lg">' +
                        '<button onclick="removeImage(' + index + ')" class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">' +
                            '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">' +
                                '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>' +
                            '</svg>' +
                        '</button>';
                    grid.appendChild(div);
                });
            } else {
                preview.style.display = 'none';
            }
        }
        
        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
            updateAnalyzeButton();
        }
        
        function updateAnalyzeButton() {
            const btn = document.getElementById('analyzeMultiBtn');
            if (selectedImages.length === 0) {
                btn.textContent = 'ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”';
                btn.disabled = true;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                btn.textContent = selectedImages.length + 'ì¥ ë¶„ì„í•˜ê¸°';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-blue-600 text-white hover:bg-blue-700';
            }
        }
        
        async function analyzeMultipleImages() {
            console.log('ğŸ” Starting multi-image analysis');
            console.log('ğŸ“¸ Image count:', selectedImages.length);
            
            const errorDiv = document.getElementById('multiError');
            const errorText = document.getElementById('multiErrorText');
            const btn = document.getElementById('analyzeMultiBtn');
            const resultDiv = document.getElementById('multiResult');
            const resultContent = document.getElementById('multiResultContent');
            
            // Hide previous error/result
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            // Check user authentication and limits
            const authData = checkAuthStatus();
            const isLoggedIn = authData && authData.isLoggedIn;
            
            // Check if payment is needed for 4+ images
            if (selectedImages.length > 3) {
                console.log('ğŸ”’ Payment required for ' + selectedImages.length + ' images');
                
                // Check if payment was recently completed
                const paymentData = localStorage.getItem('paypalPaymentCompleted');
                if (paymentData) {
                    const payment = JSON.parse(paymentData);
                    const paymentAge = Date.now() - payment.timestamp;
                    
                    // Payment expires after 1 hour
                    if (paymentAge > 3600000) {
                        localStorage.removeItem('paypalPaymentCompleted');
                        console.log('â° Payment expired');
                        showPayPalModal(selectedImages.length);
                        return;
                    } else if (payment.imageCount < selectedImages.length) {
                        console.log('ğŸ“Š Need to pay for additional images');
                        showPayPalModal(selectedImages.length);
                        return;
                    }
                    console.log('âœ… Valid payment found, proceeding with analysis');
                } else {
                    showPayPalModal(selectedImages.length);
                    return;
                }
            }
            
            // Create FormData
            const formData = new FormData();
            
            if (authData && authData.user && authData.user.id) {
                formData.append('userId', authData.user.id);
                console.log('ğŸ“¤ Logged in user mode - userId added:', authData.user.id);
            } else {
                formData.append('userId', 'anonymous-' + Date.now());
                console.log('ğŸ“¤ Guest mode - anonymous userId added');
            }
            
            // Add payment token if payment was made
            const paymentData = localStorage.getItem('paypalPaymentCompleted');
            if (paymentData && selectedImages.length > 3) {
                const payment = JSON.parse(paymentData);
                formData.append('paymentToken', payment.orderId);
                console.log('ğŸ’³ Payment token added:', payment.orderId);
            }
            
            selectedImages.forEach((file, index) => {
                formData.append('image' + index, file);
                console.log('ğŸ“ Added image' + index + ':', file.name);
            });
            
            // Update button state with animation
            btn.innerHTML = '<span class="inline-block animate-spin-slow mr-2">ğŸ”„</span> ' + selectedImages.length + 'ì¥ ë¶„ì„ ì¤‘<span class="animate-pulse-slow">...</span>';
            btn.disabled = true;
            btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-gradient-to-r from-blue-500 to-purple-500 text-white cursor-not-allowed animate-pulse-slow';
            
            try {
                console.log('ğŸš€ Sending request to /api/multi-analyze');
                
                const response = await fetch('/api/multi-analyze', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                const result = await response.json();
                console.log('ğŸ“Š Response data:', result);
                
                if (!response.ok) {
                    throw new Error(result.error || 'ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // Display results
                displayMultiImageResults(result);
                
            } catch (error) {
                console.error('âŒ Analysis error:', error);
                errorText.textContent = error.message || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                errorDiv.style.display = 'block';
            } finally {
                // Reset button state
                btn.textContent = selectedImages.length + 'ì¥ ë¶„ì„í•˜ê¸°';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-blue-600 text-white hover:bg-blue-700';
            }
        }
        
        function displayMultiImageResults(result) {
            const resultDiv = document.getElementById('multiResult');
            const resultContent = document.getElementById('multiResultContent');
            
            // ë¶„ì„ ê²°ê³¼ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (Multi-AI ìƒì„±ê¸°ì—ì„œ ì‚¬ìš©)
            window.lastMultiImageAnalysis = result;
            
            let html = '<div>';
            
            // Summary section
            html += '<div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6 mb-6">';
            html += '<h3 class="text-2xl font-bold mb-4">âœ… ë‹¤ì¤‘ ì´ë¯¸ì§€ ê³µí†µ íŒ¨í„´ ë¶„ì„ ì™„ë£Œ!</h3>';
            html += '<div class="grid grid-cols-3 gap-4">';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + result.total_images + 'ì¥</div>';
            html += '<div class="text-sm opacity-90">ë¶„ì„ëœ ì´ë¯¸ì§€</div>';
            html += '</div>';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + (result.total_processing_time / 1000).toFixed(1) + 'ì´ˆ</div>';
            html += '<div class="text-sm opacity-90">ì´ ì²˜ë¦¬ ì‹œê°„</div>';
            html += '</div>';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + (result.user_type === 'logged_in' ? 'íšŒì›' : 'ê²ŒìŠ¤íŠ¸') + '</div>';
            html += '<div class="text-sm opacity-90">ì‚¬ìš©ì ìœ í˜•</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Combined Analysis Results - Always show
            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
            html += '<h4 class="text-xl font-bold mb-4">ğŸ¯ ê³µí†µ íŒ¨í„´ ë¶„ì„ ê²°ê³¼</h4>';
            
            if (result.combined_analysis && (result.combined_analysis.common_keywords.length > 0 || result.combined_analysis.common_colors.length > 0)) {
                
                // Pattern description
                html += '<div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 mb-4">';
                html += '<p class="text-lg text-gray-800">' + result.combined_analysis.pattern_description + '</p>';
                html += '</div>';
                
                // Analysis details grid
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                html += '<div class="bg-blue-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-blue-900">ì§€ë°°ì  ìŠ¤íƒ€ì¼</div>';
                html += '<div class="text-blue-700 font-medium">' + result.combined_analysis.dominant_style + '</div>';
                html += '</div>';
                html += '<div class="bg-green-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-green-900">ì „ì²´ì  ë¶„ìœ„ê¸°</div>';
                html += '<div class="text-green-700 font-medium">' + result.combined_analysis.dominant_mood + '</div>';
                html += '</div>';
                html += '<div class="bg-purple-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-purple-900">í‰ê·  ì •í™•ë„</div>';
                html += '<div class="text-purple-700 font-medium">' + Math.round(result.combined_analysis.average_confidence * 100) + '%</div>';
                html += '</div>';
                html += '<div class="bg-orange-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-orange-900">ê³µí†µ ìš”ì†Œ</div>';
                html += '<div class="text-orange-700 font-medium">' + result.combined_analysis.common_keywords.length + 'ê°œ</div>';
                html += '</div>';
                html += '</div>';
                
                // Common colors
                if (result.combined_analysis.common_colors && result.combined_analysis.common_colors.length > 0) {
                    html += '<div class="mb-4">';
                    html += '<h5 class="font-semibold text-gray-700 mb-2">ğŸ¨ ê³µí†µ ìƒ‰ìƒ</h5>';
                    html += '<div class="flex flex-wrap gap-2">';
                    result.combined_analysis.common_colors.forEach(function(color) {
                        html += '<span class="bg-white border-2 border-gray-200 px-3 py-1 rounded-full text-sm font-medium">' + color + '</span>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                
                // Common keywords
                if (result.combined_analysis.common_keywords && result.combined_analysis.common_keywords.length > 0) {
                    html += '<div>';
                    html += '<h5 class="font-semibold text-gray-700 mb-2">ğŸ·ï¸ ê³µí†µ í‚¤ì›Œë“œ</h5>';
                    html += '<div class="flex flex-wrap gap-2">';
                    result.combined_analysis.common_keywords.forEach(function(keyword) {
                        html += '<span class="bg-gray-100 px-3 py-1 rounded-full text-sm text-gray-700">' + keyword + '</span>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            } else {
                // No common patterns found - show helpful message
                html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">';
                html += '<p class="text-yellow-800">âš ï¸ ê³µí†µ íŒ¨í„´ì„ ì°¾ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë“¤ì´ ì„œë¡œ ë‹¤ë¥¸ íŠ¹ì§•ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.</p>';
                
                // Still show individual analyses summary
                if (result.individual_analyses && result.individual_analyses.length > 0) {
                    html += '<div class="mt-4">';
                    html += '<p class="text-sm font-semibold text-yellow-900 mb-2">ê°œë³„ ì´ë¯¸ì§€ ë¶„ì„ ìš”ì•½:</p>';
                    html += '<ul class="text-sm text-yellow-700 space-y-1">';
                    result.individual_analyses.forEach(function(analysis, index) {
                        html += '<li>â€¢ ' + analysis.image_name + ': ';
                        html += (analysis.style || 'N/A') + ' ìŠ¤íƒ€ì¼, ';
                        html += (analysis.mood || 'N/A') + ' ë¶„ìœ„ê¸°';
                        if (analysis.colors && analysis.colors.length > 0) {
                            html += ', ì£¼ìš” ìƒ‰ìƒ: ' + analysis.colors.slice(0, 2).join(', ');
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            
            
            // Recommendations based on common patterns
            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
                html += '<h4 class="text-xl font-bold mb-4">ğŸ¨ ê³µí†µ íŒ¨í„´ ê¸°ë°˜ ì¶”ì²œ ì‘í’ˆ</h4>';
                html += '<p class="text-gray-600 mb-4">ì„ íƒí•˜ì‹  ì´ë¯¸ì§€ë“¤ì˜ ê³µí†µëœ íŠ¹ì§•ì„ ë°”íƒ•ìœ¼ë¡œ ì¶”ì²œëœ ì‘í’ˆì…ë‹ˆë‹¤.</p>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                
                result.recommendations.forEach(function(rec) {
                    const artwork = rec.artwork || rec;
                    const imageUrl = artwork.image_url || artwork.thumbnail_url || '';
                    const title = artwork.title || 'ì œëª© ì—†ìŒ';
                    const artist = artwork.artist || 'ì‘ê°€ ë¯¸ìƒ';
                    const similarity = Math.round((rec.similarity || 0) * 100);
                    
                    let source = 'Unknown';
                    if (artwork.metadata?.source) {
                        source = artwork.metadata.source;
                    } else if (artwork.source) {
                        source = artwork.source;
                    } else if (artwork.id?.startsWith('met_')) {
                        source = 'Met Museum';
                    } else if (artwork.id?.startsWith('local_')) {
                        source = 'Local DB';
                    }
                    
                    html += '<div class="bg-gray-50 rounded-lg p-4 hover:shadow-lg transition-all">';
                    html += '<div class="flex items-start space-x-3">';
                    if (imageUrl) {
                        html += '<img src="' + imageUrl + '" alt="' + title + '" class="w-24 h-24 object-cover rounded-lg" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">';
                        html += '<div class="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl" style="display:none;">ğŸ¨</div>';
                    } else {
                        html += '<div class="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl">ğŸ¨</div>';
                    }
                    html += '<div class="flex-1">';
                    html += '<h6 class="font-bold text-gray-900 mb-1">' + title + '</h6>';
                    html += '<p class="text-sm text-gray-600 mb-2">' + artist + '</p>';
                    html += '<div class="flex items-center justify-between">';
                    html += '<span class="text-xs px-2 py-1 bg-white rounded-full text-gray-600">' + source + '</span>';
                    html += '<span class="text-xs text-blue-600 font-semibold">' + similarity + '% ì¼ì¹˜</span>';
                    html += '</div>';
                    if (artwork.source_url) {
                        html += '<a href="' + artwork.source_url + '" target="_blank" class="inline-block mt-2 text-xs text-blue-500 hover:text-blue-700 underline">ìƒì„¸ë³´ê¸° â†’</a>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
                html += '</div>';
            } else {
                // No recommendations found
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
                html += '<h4 class="text-xl font-bold mb-4">ğŸ¨ ì¶”ì²œ ì‘í’ˆ</h4>';
                html += '<div class="bg-gray-50 rounded-lg p-6 text-center">';
                html += '<div class="text-4xl mb-2">ğŸ”</div>';
                html += '<p class="text-gray-600">ìœ ì‚¬í•œ ì‘í’ˆì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                html += '<p class="text-sm text-gray-500 mt-2">ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ì‹œë„í•´ë³´ì‹œê±°ë‚˜, ë” êµ¬ì²´ì ì¸ íŠ¹ì§•ì´ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
                html += '</div>';
                html += '</div>';
            }
            
            // Individual image brief info (collapsed by default)
            if (result.individual_analyses && result.individual_analyses.length > 0) {
                html += '<details class="bg-gray-50 rounded-lg p-4">';
                html += '<summary class="cursor-pointer font-semibold text-gray-700 hover:text-gray-900">ğŸ“‹ ê°œë³„ ì´ë¯¸ì§€ ë¶„ì„ ìƒì„¸ (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)</summary>';
                html += '<div class="mt-4 space-y-3">';
                
                result.individual_analyses.forEach(function(imageResult, index) {
                    html += '<div class="bg-white rounded-lg p-4 border-l-2 border-gray-300">';
                    
                    // Image header (simplified)
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<div class="flex items-center space-x-2">';
                    html += '<span class="bg-gray-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">' + (index + 1) + '</span>';
                    html += '<span class="font-medium text-gray-800">' + imageResult.image_name + '</span>';
                    html += '</div>';
                    html += '<span class="text-xs text-gray-500">' + (imageResult.processing_time / 1000).toFixed(1) + 'ì´ˆ</span>';
                    html += '</div>';
                    
                    // Simplified info in one line
                    html += '<div class="text-sm text-gray-600">';
                    html += 'ìŠ¤íƒ€ì¼: <span class="font-medium">' + (imageResult.style || 'N/A') + '</span> | ';
                    html += 'ë¶„ìœ„ê¸°: <span class="font-medium">' + (imageResult.mood || 'N/A') + '</span> | ';
                    html += 'ìƒ‰ìƒ: <span class="font-medium">' + (imageResult.colors ? imageResult.colors.slice(0, 3).join(', ') : 'N/A') + '</span>';
                    html += '</div>';
                    
                    html += '</div>';
                });
                
                html += '</div>';
                html += '</details>';
            }
            
            html += '</div>';
            
            resultContent.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // Store common analysis data globally for image generation
            window.lastCommonAnalysis = result.combined_analysis;
        }
        
        // ì´ë¯¸ì§€ ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        function handleImageError(img) {
            console.log('âŒ Image failed to load:', img.src);
            
            // ë¶€ëª¨ ì¹´ë“œ ì „ì²´ë¥¼ ìˆ¨ê¹€
            const card = img.closest('[style*="border: 1px solid"]');
            if (card) {
                card.style.display = 'none';
                console.log('ğŸš« Hiding card with failed image:', img.alt);
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            updateRecommendationStats();
        }
        
        function handleImageLoad(img) {
            console.log('âœ… Image loaded successfully:', img.alt);
        }
        
        function updateRecommendationStats() {
            // í‘œì‹œë˜ëŠ” ì¹´ë“œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
            const visibleCards = document.querySelectorAll('[style*="border: 1px solid"]:not([style*="display: none"])');
            const totalHeader = document.querySelector('h4[style*="ì¶”ì²œ ì‘í’ˆ"]');
            if (totalHeader && visibleCards.length > 0) {
                totalHeader.innerHTML = '<strong>ğŸ¨ ì¶”ì²œ ì‘í’ˆ (' + visibleCards.length + 'ê°œ í‘œì‹œì¤‘)</strong>';
            }
        }

        // ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ ê´€ë ¨ ë³€ìˆ˜
        let singleImageFile = null;
        
        // ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ í•¨ìˆ˜ë“¤
        function initSingleImageUpload() {
            const input = document.getElementById('singleImageInput');
            const uploadArea = document.getElementById('singleUploadArea');
            
            if (input) {
                input.addEventListener('change', handleSingleImageSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', handleSingleDragOver);
                uploadArea.addEventListener('dragleave', handleSingleDragLeave);
                uploadArea.addEventListener('drop', handleSingleDrop);
            }
        }
        
        function handleSingleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
        }
        
        function handleSingleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
        }
        
        function handleSingleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleSingleFile(files[0]);
            }
        }
        
        function handleSingleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleSingleFile(file);
            }
        }
        
        function handleSingleFile(file) {
            // íŒŒì¼ ê²€ì¦
            if (!file.type.startsWith('image/')) {
                showSingleError('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showSingleError('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            singleImageFile = file;
            
            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('singlePreviewImg');
                const imageInfo = document.getElementById('singleImageInfo');
                const uploadContent = document.getElementById('singleUploadContent');
                const imagePreview = document.getElementById('singleImagePreview');
                
                previewImg.src = e.target.result;
                imageInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                
                uploadContent.style.display = 'none';
                imagePreview.style.display = 'block';
                
                hideSingleError();
                hideSingleResult();
            };
            reader.readAsDataURL(file);
        }
        
        function clearSingleImage() {
            singleImageFile = null;
            
            const uploadContent = document.getElementById('singleUploadContent');
            const imagePreview = document.getElementById('singleImagePreview');
            const input = document.getElementById('singleImageInput');
            
            if (uploadContent) uploadContent.style.display = 'block';
            if (imagePreview) imagePreview.style.display = 'none';
            if (input) input.value = '';
            
            hideSingleError();
            hideSingleResult();
            hideSingleLoading();
        }
        
        async function analyzeSingleImage() {
            if (!singleImageFile) {
                showSingleError('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            showSingleLoading();
            hideSingleError();
            hideSingleResult();
            
            const formData = new FormData();
            formData.append('image', singleImageFile);
            
            // ì‚¬ìš©ì ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            const authData = checkAuthStatus();
            if (authData && authData.user && authData.user.id) {
                formData.append('userId', authData.user.id);
            } else {
                formData.append('userId', 'anonymous-' + Date.now());
            }
            
            try {
                console.log('ğŸ” ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ ì‹œì‘...');
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                console.log('ğŸ“Š ë¶„ì„ ê²°ê³¼:', data);
                
                hideSingleLoading();
                
                if (data.success) {
                    displaySingleResult(data);
                } else {
                    showSingleError(data.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë¶„ì„ ì—ëŸ¬:', error);
                hideSingleLoading();
                showSingleError('ì„œë²„ì™€ì˜ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function showSingleLoading() {
            const loading = document.getElementById('singleLoading');
            if (loading) loading.style.display = 'block';
            
            // Also update analyze button
            const btn = document.getElementById('singleAnalyzeBtn');
            if (btn) {
                btn.innerHTML = '<span class="inline-block animate-spin-slow mr-2">ğŸ”„</span> ë¶„ì„ ì¤‘<span class="animate-pulse-slow">...</span>';
                btn.disabled = true;
                btn.className = 'w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg animate-pulse-slow cursor-not-allowed';
            }
        }
        
        function hideSingleLoading() {
            const loading = document.getElementById('singleLoading');
            if (loading) loading.style.display = 'none';
            
            // Reset analyze button
            const btn = document.getElementById('singleAnalyzeBtn');
            if (btn) {
                btn.innerHTML = 'âœ¨ AI ë¶„ì„ ì‹œì‘';
                btn.disabled = false;
                btn.className = 'w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg';
            }
        }
        
        function showSingleError(message) {
            const errorDiv = document.getElementById('singleError');
            const errorText = document.getElementById('singleErrorText');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function hideSingleError() {
            const errorDiv = document.getElementById('singleError');
            if (errorDiv) errorDiv.style.display = 'none';
        }
        
        function hideSingleResult() {
            const resultDiv = document.getElementById('singleResult');
            if (resultDiv) resultDiv.style.display = 'none';
        }
        
        function displaySingleResult(data) {
            const resultDiv = document.getElementById('singleResult');
            const analysisDetails = document.getElementById('singleAnalysisDetails');
            const recommendationsDiv = document.getElementById('singleRecommendations');
            
            if (!resultDiv || !analysisDetails || !recommendationsDiv) return;
            
            // ë¶„ì„ ì •ë³´ í‘œì‹œ
            analysisDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold text-blue-900 mb-2">ğŸ¨ ìŠ¤íƒ€ì¼</h4>
                        <p class="text-blue-700">${data.analysis.style || 'ë¶„ì„ ì¤‘...'}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-900 mb-2">ğŸŒˆ ì£¼ìš” ìƒ‰ìƒ</h4>
                        <p class="text-green-700">${data.analysis.colors?.join(', ') || 'ë¶„ì„ ì¤‘...'}</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-purple-900 mb-2">ğŸ˜Š ë¶„ìœ„ê¸°</h4>
                        <p class="text-purple-700">${data.analysis.mood || 'ë¶„ì„ ì¤‘...'}</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h4 class="font-bold text-orange-900 mb-2">ğŸ¯ ì •í™•ë„</h4>
                        <p class="text-orange-700">${Math.round((data.analysis.confidence || 0) * 100)}%</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-gray-900 mb-2">ğŸ·ï¸ í‚¤ì›Œë“œ</h4>
                    <div class="flex flex-wrap gap-2">
                        ${data.analysis.keywords?.map(keyword => 
                            `<span class="bg-white px-3 py-1 rounded-full text-sm text-gray-700 border">${keyword}</span>`
                        ).join('') || 'ë¶„ì„ ì¤‘...'}
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <p>â±ï¸ ì²˜ë¦¬ ì‹œê°„: ${data.processing_time}ms</p>
                    <p>ğŸ“ ì´ë¯¸ì§€ í¬ê¸°: ${(data.image_size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
            
            // ì¶”ì²œ ì‘í’ˆ í‘œì‹œ
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsDiv.innerHTML = `
                    <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 mt-4 sm:mt-6">ğŸ¨ ì¶”ì²œ ì‘í’ˆ (${data.recommendations.length}ê°œ)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        ${data.recommendations.map(rec => {
                            const artwork = rec.artwork || rec;
                            const imageUrl = artwork.image_url || artwork.thumbnail_url || '';
                            const title = artwork.title || 'ì œëª© ì—†ìŒ';
                            const artist = artwork.artist || 'ì‘ê°€ ë¯¸ìƒ';
                            const similarity = Math.round((rec.similarity || 0) * 100);
                            
                            // ì†ŒìŠ¤ ê²°ì •
                            let source = 'Unknown';
                            if (artwork.metadata?.source) {
                                source = artwork.metadata.source;
                            } else if (artwork.source) {
                                source = artwork.source;
                            } else if (artwork.id?.startsWith('met_')) {
                                source = 'Met Museum';
                            } else if (artwork.id?.startsWith('local_')) {
                                source = 'Local DB';
                            }
                            
                            return `
                            <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-all">
                                <div class="flex items-start space-x-4">
                                    ${imageUrl ? 
                                        `<img src="${imageUrl}" alt="${title}" class="w-20 h-20 object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                         <div class="w-20 h-20 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl" style="display:none;">ğŸ¨</div>` : 
                                        `<div class="w-20 h-20 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl">ğŸ¨</div>`
                                    }
                                    <div class="flex-1">
                                        <h5 class="font-bold text-gray-900 mb-1 line-clamp-2">${title}</h5>
                                        <p class="text-sm text-gray-600 mb-2">${artist}</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-2 py-1 bg-gray-100 rounded-full text-gray-600">${source}</span>
                                            <span class="text-xs text-blue-600 font-medium">${similarity}% ì¼ì¹˜</span>
                                        </div>
                                        ${artwork.source_url ? 
                                            `<a href="${artwork.source_url}" target="_blank" class="inline-block mt-2 text-xs text-blue-500 hover:text-blue-700 underline">ì‘í’ˆ ìƒì„¸ë³´ê¸° â†’</a>` : 
                                            ''
                                        }
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                recommendationsDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500 mt-6">
                        <div class="text-4xl mb-2">ğŸ”</div>
                        <p>ìœ ì‚¬í•œ ì‘í’ˆì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm mt-1">ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        }

        // Generate from manual keywords
        async function generateFromManualKeywords() {
            const keywordsInput = document.getElementById('manualKeywords');
            const keywords = keywordsInput.value.trim().split(',').map(k => k.trim()).filter(k => k);
            
            if (keywords.length === 0) {
                alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Get advanced options
            const style = document.getElementById('aiStyle')?.value || 'artistic';
            const mood = document.getElementById('aiMood')?.value || 'peaceful';
            const colors = document.getElementById('aiColors')?.value.split(',').map(c => c.trim()).filter(c => c) || [];
            const size = parseInt(document.getElementById('aiSize')?.value || '768');
            
            await generateAIImageWithParams(keywords, style, mood, colors, size);
        }
        
        // Common AI image generation function with parameters
        async function generateAIImageWithParams(keywords, style, mood, colors, size) {
            // Determine which result area to use based on current view
            const isGeneratorTab = document.getElementById('aiGeneratorResult') !== null;
            const area = isGeneratorTab ? document.getElementById('aiGeneratorResult') : document.getElementById('generatedImageArea');
            const content = isGeneratorTab ? document.getElementById('aiGeneratorContent') : document.getElementById('generatedImageContent');
            
            if (!area || !content) {
                console.error('Result area not found');
                return;
            }
            
            // Show loading
            area.classList.remove('hidden');
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin inline-block w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-600">AIê°€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    <p class="text-sm text-gray-500 mt-2">ì´ ì‘ì—…ì€ 30ì´ˆ~1ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        style: style,
                        mood: mood,
                        colors: colors,
                        width: size,
                        height: size
                    })
                });
                
                const result = await response.json();
                
                if (result.success || result.placeholder) {
                    // Display generated image
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div class="relative">
                                <img src="${result.imageUrl}" alt="AI Generated Image" class="w-full rounded-lg shadow-lg">
                                ${result.placeholder ? '<div class="absolute top-2 right-2 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm">í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€</div>' : ''}
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-semibold text-gray-700 mb-2">ğŸ¨ ìƒì„± í”„ë¡¬í”„íŠ¸</h5>
                                <p class="text-sm text-gray-600 italic">${result.prompt || 'ìë™ ìƒì„±ëœ í”„ë¡¬í”„íŠ¸'}</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <div class="text-sm font-semibold text-blue-900">ì²˜ë¦¬ ì‹œê°„</div>
                                    <div class="text-blue-700 font-medium">${result.processingTime ? (result.processingTime / 1000).toFixed(1) + 'ì´ˆ' : 'N/A'}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3">
                                    <div class="text-sm font-semibold text-green-900">ìƒì„± ì„œë¹„ìŠ¤</div>
                                    <div class="text-green-700 font-medium">${result.services ? result.services.join(', ') : 'Placeholder'}</div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="downloadGeneratedImage('${result.imageUrl}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                    ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                                </button>
                                <button onclick="${isGeneratorTab ? 'generateFromManualKeywords()' : 'generateAIImage()'}" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                                    ğŸ”„ ë‹¤ì‹œ ìƒì„±í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Error occurred
                    content.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-red-800">
                                <span class="text-2xl">âŒ</span>
                                <div>
                                    <p class="font-semibold">ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨</p>
                                    <p class="text-sm mt-1">${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Image generation error:', error);
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800">âŒ ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>
                    </div>
                `;
            }
        }
        
        // AI Image Generation Function
        async function generateAIImage() {
            if (!window.lastCommonAnalysis) {
                alert('ë¨¼ì € ë‹¤ì¤‘ ì´ë¯¸ì§€ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const style = window.lastCommonAnalysis.dominant_style || 'artistic';
            const mood = window.lastCommonAnalysis.dominant_mood || 'balanced';
            const colors = window.lastCommonAnalysis.common_colors || [];
            const keywords = window.lastCommonAnalysis.common_keywords || [];
            
            // AI generation removed
            alert('ì´ë¯¸ì§€ ìƒì„± ê¸°ëŠ¥ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // Download generated image function
        function downloadGeneratedImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'ai-generated-image-' + Date.now() + '.png';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            // ë‹¨ì¼ ì´ë¯¸ì§€ ë¶„ì„ì´ í™œì„±í™”ë  ë•Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ê¸° ìœ„í•´ setTimeout ì‚¬ìš©
            setTimeout(initSingleImageUpload, 100);
        });
        // PayPal Modal Functions
        function showPayPalModal(imageCount) {
            const modal = document.getElementById('paypalModal');
            const priceElement = document.getElementById('paypalPrice');
            const countElement = document.getElementById('paypalImageCount');
            
            // Calculate price
            let price = 5; // Default for 4-10 images
            if (imageCount > 10) {
                price = 10; // Premium for 11+ images
            }
            
            countElement.textContent = imageCount + 'ì¥';
            priceElement.textContent = '$' + price + '.00';
            
            modal.classList.remove('hidden');
            
            // Render PayPal button
            renderPayPalButton(price, imageCount);
        }
        
        function closePayPalModal() {
            const modal = document.getElementById('paypalModal');
            modal.classList.add('hidden');
            
            // Clear PayPal button
            document.getElementById('paypal-button-container').innerHTML = '';
        }
        
        function renderPayPalButton(price, imageCount) {
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = ''; // Clear previous buttons
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: price.toString(),
                                currency_code: 'USD'
                            },
                            description: 'AI Art Analysis - ' + imageCount + ' images'
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        console.log('âœ… Payment successful:', details);
                        
                        // Store payment info
                        localStorage.setItem('paypalPaymentCompleted', JSON.stringify({
                            orderId: data.orderID,
                            imageCount: imageCount,
                            price: price,
                            timestamp: Date.now(),
                            payerName: details.payer.name.given_name + ' ' + details.payer.name.surname,
                            payerEmail: details.payer.email_address
                        }));
                        
                        // Show success message
                        document.getElementById('paypal-button-container').style.display = 'none';
                        document.getElementById('paypalSuccess').classList.remove('hidden');
                        
                        // Auto close and proceed with analysis after 2 seconds
                        setTimeout(function() {
                            closePayPalModal();
                            analyzeMultipleImages(); // Retry analysis after payment
                        }, 2000);
                    });
                },
                onError: function(err) {
                    console.error('âŒ PayPal error:', err);
                    alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                },
                onCancel: function(data) {
                    console.log('âš ï¸ Payment cancelled');
                }
            }).render('#paypal-button-container');
        }
    </script>
    
    <!-- PayPal Payment Modal -->
    <div id="paypalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">ğŸ’³ ê²°ì œê°€ í•„ìš”í•©ë‹ˆë‹¤</h2>
                    <p class="text-gray-600">4ì¥ ì´ìƒì˜ ì´ë¯¸ì§€ ë¶„ì„ì„ ìœ„í•´ ê²°ì œê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
                    <p class="text-xs text-green-600 mt-2">âœ… ì‹¤ì œ ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤</p>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">ë¶„ì„í•  ì´ë¯¸ì§€:</span>
                        <span id="paypalImageCount" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium">ê²°ì œ ê¸ˆì•¡:</span>
                        <span id="paypalPrice" class="text-lg font-bold text-green-600"></span>
                    </div>
                </div>
                
                <!-- PayPal Button Container -->
                <div id="paypal-button-container" class="mb-4"></div>
                
                <!-- Cancel Button -->
                <button onclick="closePayPalModal()" class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                    ì·¨ì†Œ
                </button>
                
                <!-- Success Message -->
                <div id="paypalSuccess" class="hidden text-center">
                    <div class="text-green-600 text-6xl mb-4">âœ“</div>
                    <h3 class="text-xl font-bold mb-2">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                    <p class="text-gray-600 mb-4">ì´ì œ ì´ë¯¸ì§€ ë¶„ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>