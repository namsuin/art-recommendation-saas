<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Art Recommendation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PayPal SDK with Live Credentials -->
    <script src="https://www.paypal.com/sdk/js?client-id=AZb37RpQo5rEjg4CdahNsQ2qUm6UrQwivySQ-AxvKqszkUtzGu39Hje2XtpfvKEr9KDBZgYx8EBN5Hv_&currency=USD"></script>
    <style>
        .line-clamp-1 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
        }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <div id="root" class="min-h-screen">
        <!-- Loading placeholder -->
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
                AI Art Recommendation
            </h1>
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">로딩 중...</p>
            </div>
        </div>
    </div>

    <!-- Simple JavaScript implementation instead of React -->
    <script>
        console.log('🚀 AI Art Recommendation App loaded');
        
        let currentUser = null;
        let viewMode = 'single';
        
        // 단일 이미지 분석 모드로 전환하는 함수
        function goToAnalyzePage() {
            console.log('🤖 단일 이미지 분석 모드로 전환...');
            setViewMode('single');
        }
        
        function checkAuthStatus() {
            try {
                const auth = localStorage.getItem('auth');
                if (auth) {
                    const authData = JSON.parse(auth);
                    if (authData.isLoggedIn && authData.user) {
                        currentUser = authData.user;
                        console.log('✅ 로그인된 사용자:', authData.user.email);
                        return authData;
                    }
                }
            } catch (error) {
                console.error('인증 상태 확인 오류:', error);
                localStorage.removeItem('auth');
            }
            return null;
        }

        function logout() {
            localStorage.removeItem('auth');
            currentUser = null;
            window.location.reload();
        }

        function initializeApp() {
            console.log('📍 Initializing app');
            
            // 로그인 상태 확인
            const authData = checkAuthStatus();
            
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <header class="bg-white shadow-sm border-b">
                        <div class="container mx-auto px-4 py-3 sm:py-4">
                            <div class="flex items-center justify-between">
                                <h1 class="text-lg sm:text-2xl font-bold text-gray-800">AI Art</h1>
                                <div class="flex items-center">
                                    ${authData ? `
                                        <div class="flex items-center space-x-2">
                                            <span class="hidden sm:inline text-sm text-gray-600">안녕하세요, ${authData.profile?.display_name || authData.user.email}님!</span>
                                            <div class="dropdown relative">
                                                <button class="bg-gray-100 hover:bg-gray-200 px-3 py-2 rounded-md text-sm">
                                                    <span class="sm:hidden">메뉴</span>
                                                    <span class="hidden sm:inline">내 계정</span>
                                                </button>
                                                <div class="dropdown-content hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
                                                    <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">프로필</a>
                                                    <a href="/social" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">소셜</a>
                                                    <hr class="my-1">
                                                    <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">로그아웃</button>
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="flex items-center space-x-2">
                                            <a href="/auth" class="text-gray-600 hover:text-gray-800 px-2 sm:px-3 py-1 sm:py-2 text-sm">로그인</a>
                                            <a href="/auth" class="bg-blue-500 hover:bg-blue-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-md text-sm">회원가입</a>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- Main Content -->
                    <main class="container mx-auto px-4 py-8">
                        <div class="max-w-4xl mx-auto space-y-8">
                            <!-- Mode Selector -->
                            <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4">
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                    <button onclick="setViewMode('single')" id="singleBtn" class="px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base">
                                        <span class="block sm:hidden">단일 분석</span>
                                        <span class="hidden sm:block">단일 이미지 분석</span>
                                    </button>
                                    <button onclick="setViewMode('multi')" id="multiBtn" class="px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base">
                                        <span class="block sm:hidden">다중 분석</span>
                                        <span class="hidden sm:block">다중 이미지 분석</span>
                                    </button>
                                    <button onclick="alert('AI 개인화 추천은 개발 중입니다')" class="col-span-2 sm:col-span-1 px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base">
                                        <span class="block sm:hidden">🤖 AI 추천</span>
                                        <span class="hidden sm:block">🤖 AI 개인화 추천</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Content Area -->
                            <div id="contentArea">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </main>
                </div>
            `;
            
            // Initialize with single mode
            setViewMode('single');
        }
        
        function setViewMode(mode) {
            console.log('🔄 Setting view mode:', mode);
            viewMode = mode;
            
            // Update button styles with responsive classes
            const buttons = ['singleBtn', 'multiBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (btnId === mode + 'Btn') {
                        btn.className = 'px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white text-sm sm:text-base';
                    } else {
                        btn.className = 'px-3 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm sm:text-base';
                    }
                }
            });
            
            // Load content based on mode
            const contentArea = document.getElementById('contentArea');
            if (mode === 'single') {
                contentArea.innerHTML = getSingleImageHTML();
                // 단일 이미지 분석 이벤트 리스너 초기화
                setTimeout(initSingleImageUpload, 50);
            } else if (mode === 'multi') {
                contentArea.innerHTML = getMultiImageHTML();
                initMultiImageUpload();
            }
        }
        
        
        function getSingleImageHTML() {
            return '<div class="bg-white rounded-lg shadow-lg p-4 sm:p-6">' +
                '<h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4">🤖 단일 이미지 분석</h2>' +
                '<p class="text-sm sm:text-base text-gray-600">AI가 이미지를 분석하여 스타일, 색상, 분위기를 파악하고 유사한 작품을 추천해드립니다.</p>' +
                
                // 이미지 업로드 영역
                '<div id="singleUploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 sm:p-8 text-center hover:border-blue-400 transition-colors cursor-pointer mt-2" onclick="document.getElementById(\'singleImageInput\').click()">' +
                '<div id="singleUploadContent">' +
                '<div class="text-3xl sm:text-4xl mb-2">🎨</div>' +
                '<p class="text-sm sm:text-base text-gray-500 mb-2 sm:mb-4">드래그 앤 드롭으로 이미지를 업로드하거나<br class="hidden sm:block"><span class="sm:hidden"> </span>여기를 클릭하여 시작하세요</p>' +
                '<p class="text-xs sm:text-sm text-gray-400">JPG, PNG, GIF 지원 (최대 10MB)</p>' +
                '</div>' +
                '</div>' +
                '<input type="file" id="singleImageInput" accept="image/*" style="display: none;">' +
                
                // 이미지 미리보기
                '<div id="singleImagePreview" style="display: none;" class="mt-4">' +
                '<div class="relative group">' +
                '<img id="singlePreviewImg" src="" alt="Preview" class="w-full max-h-64 object-contain rounded-lg shadow-lg mx-auto">' +
                '</div>' +
                '<p id="singleImageInfo" class="text-sm text-gray-600 mt-2 text-center"></p>' +
                '<div class="flex gap-3 mt-4">' +
                '<button id="singleChangeBtn" onclick="document.getElementById(\'singleImageInput\').click()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">새 이미지 선택</button>' +
                '<button id="singleRemoveBtn" onclick="clearSingleImage()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">삭제</button>' +
                '</div>' +
                '<button id="singleAnalyzeBtn" onclick="analyzeSingleImage()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all mt-4 shadow-lg">✨ AI 분석 시작</button>' +
                '</div>' +
                
                // 로딩 상태
                '<div id="singleLoading" style="display: none;" class="mt-4 text-center">' +
                '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>' +
                '<p class="text-gray-600">AI가 이미지를 분석 중입니다...</p>' +
                '</div>' +
                
                // 에러 메시지
                '<div id="singleError" style="display: none;" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">' +
                '<p id="singleErrorText" class="text-red-700"></p>' +
                '</div>' +
                
                // 분석 결과
                '<div id="singleResult" style="display: none;" class="mt-6">' +
                '<h3 class="text-lg font-bold mb-4">📊 분석 결과</h3>' +
                '<div id="singleAnalysisDetails"></div>' +
                '<div id="singleRecommendations"></div>' +
                '</div>' +
                
                '</div>';
        }
        
        // AI Generator removed
        
        function getMultiImageHTML() {
            var html = '';
            html += '<div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 md:p-8">';
            html += '<h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-4 sm:mb-6">다중 이미지 분석</h2>';
            
            // 게스트 모드 안내
            html += '<div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-green-50 border border-green-200 rounded-lg">';
            html += '<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">';
            html += '<div>';
            html += '<p class="text-xs sm:text-sm text-green-800">';
            html += '<strong>🎉 게스트 모드:</strong> 로그인 없이도 최대 3장까지 무료로 분석할 수 있습니다!';
            html += '</p>';
            html += '<p class="text-xs text-green-600 mt-1">';
            html += '💡 4장 이상 분석하려면 로그인 후 결제가 필요합니다.';
            html += '</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // 가격 정보
            html += '<div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-blue-50 rounded-lg">';
            html += '<h3 class="font-semibold mb-2 text-sm sm:text-base">가격 안내</h3>';
            html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-4 text-xs sm:text-sm">';
            html += '<div class="p-2 rounded bg-blue-100 font-semibold">';
            html += '<div>무료</div>';
            html += '<div class="text-gray-600">최대 3장</div>';
            html += '<div class="text-xs text-green-600 mt-1">게스트 가능</div>';
            html += '</div>';
            html += '<div class="p-2 rounded">'; 
            html += '<div>$5</div>';
            html += '<div class="text-gray-600">4-10장</div>';
            html += '<div class="text-xs text-red-600 mt-1">로그인 필요</div>';
            html += '</div>';
            html += '<div class="p-2 rounded">';
            html += '<div>$10</div>';
            html += '<div class="text-gray-600">11장 이상</div>';
            html += '<div class="text-xs text-red-600 mt-1">로그인 필요</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // 이미지 업로드
            html += '<div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-gray-400 transition-colors" onclick="document.getElementById(\'multiImageInput\').click()">';
            html += '<svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>';
            html += '</svg>';
            html += '<p class="text-gray-600">클릭하거나 이미지를 드래그하여 업로드</p>';
            html += '<p class="text-sm text-gray-500 mt-2">최대 50장, 각 10MB 이하</p>';
            html += '</div>';
            html += '<input type="file" id="multiImageInput" multiple accept="image/*" style="display: none;">';
            
            // 업로드된 이미지 미리보기
            html += '<div id="imagePreview" style="display: none;">';
            html += '<div class="mt-6">';
            html += '<h3 class="font-semibold mb-4">업로드된 이미지 (<span id="imageCount">0</span>장)</h3>';
            html += '<div id="imageGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>';
            html += '</div>';
            html += '</div>';
            
            // 에러 메시지
            html += '<div id="multiError" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg" style="display: none;">';
            html += '<div class="flex items-center">';
            html += '<svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">';
            html += '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>';
            html += '</svg>';
            html += '<span id="multiErrorText" class="text-red-700"></span>';
            html += '</div>';
            html += '</div>';

            // 분석 버튼
            html += '<div class="mt-6 flex flex-col items-center space-y-4">';
            html += '<button id="analyzeMultiBtn" onclick="analyzeMultipleImages()" disabled class="px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed">';
            html += '이미지를 선택해주세요';
            html += '</button>';
            html += '</div>';
            
            // 분석 결과
            html += '<div id="multiResult" style="display: none;" class="mt-8 bg-white rounded-lg shadow-lg p-8">';
            html += '<h3 class="text-xl font-bold mb-4">다중 이미지 분석 결과</h3>';
            html += '<div id="multiResultContent"></div>';
            html += '</div>';
            html += '</div>';
            
            return html;
        }
        
        let selectedImages = [];
        
        function initMultiImageUpload() {
            const input = document.getElementById('multiImageInput');
            if (input) {
                input.addEventListener('change', handleImageSelection);
            }
        }
        
        function handleImageSelection(event) {
            console.log('📸 Images selected');
            selectedImages = Array.from(event.target.files);
            updateImagePreview();
            updateAnalyzeButton();
        }
        
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            const grid = document.getElementById('imageGrid');
            const count = document.getElementById('imageCount');
            
            if (selectedImages.length > 0) {
                preview.style.display = 'block';
                count.textContent = selectedImages.length;
                
                grid.innerHTML = '';
                selectedImages.forEach((file, index) => {
                    const url = URL.createObjectURL(file);
                    const div = document.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = 
                        '<img src="' + url + '" alt="' + file.name + '" class="w-full h-24 object-cover rounded-lg">' +
                        '<button onclick="removeImage(' + index + ')" class="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">' +
                            '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">' +
                                '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>' +
                            '</svg>' +
                        '</button>';
                    grid.appendChild(div);
                });
            } else {
                preview.style.display = 'none';
            }
        }
        
        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
            updateAnalyzeButton();
        }
        
        function updateAnalyzeButton() {
            const btn = document.getElementById('analyzeMultiBtn');
            if (selectedImages.length === 0) {
                btn.textContent = '이미지를 선택해주세요';
                btn.disabled = true;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                btn.textContent = selectedImages.length + '장 분석하기';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-blue-600 text-white hover:bg-blue-700';
            }
        }
        
        async function analyzeMultipleImages() {
            console.log('🔍 Starting multi-image analysis');
            console.log('📸 Image count:', selectedImages.length);
            
            const errorDiv = document.getElementById('multiError');
            const errorText = document.getElementById('multiErrorText');
            const btn = document.getElementById('analyzeMultiBtn');
            const resultDiv = document.getElementById('multiResult');
            const resultContent = document.getElementById('multiResultContent');
            
            // Hide previous error/result
            errorDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            
            // Check user authentication and limits
            const authData = checkAuthStatus();
            const isLoggedIn = authData && authData.isLoggedIn;
            
            // Check if payment is needed for 4+ images
            if (selectedImages.length > 3) {
                console.log('🔒 Payment required for ' + selectedImages.length + ' images');
                
                // Check if payment was recently completed
                const paymentData = localStorage.getItem('paypalPaymentCompleted');
                if (paymentData) {
                    const payment = JSON.parse(paymentData);
                    const paymentAge = Date.now() - payment.timestamp;
                    
                    // Payment expires after 1 hour
                    if (paymentAge > 3600000) {
                        localStorage.removeItem('paypalPaymentCompleted');
                        console.log('⏰ Payment expired');
                        showPayPalModal(selectedImages.length);
                        return;
                    } else if (payment.imageCount < selectedImages.length) {
                        console.log('📊 Need to pay for additional images');
                        showPayPalModal(selectedImages.length);
                        return;
                    }
                    console.log('✅ Valid payment found, proceeding with analysis');
                } else {
                    showPayPalModal(selectedImages.length);
                    return;
                }
            }
            
            // Create FormData
            const formData = new FormData();
            
            if (authData && authData.user && authData.user.id) {
                formData.append('userId', authData.user.id);
                console.log('📤 Logged in user mode - userId added:', authData.user.id);
            } else {
                formData.append('userId', 'anonymous-' + Date.now());
                console.log('📤 Guest mode - anonymous userId added');
            }
            
            // Add payment token if payment was made
            const paymentData = localStorage.getItem('paypalPaymentCompleted');
            if (paymentData && selectedImages.length > 3) {
                const payment = JSON.parse(paymentData);
                formData.append('paymentToken', payment.orderId);
                console.log('💳 Payment token added:', payment.orderId);
            }
            
            selectedImages.forEach((file, index) => {
                formData.append('image' + index, file);
                console.log('📎 Added image' + index + ':', file.name);
            });
            
            // Update button state with animation
            btn.innerHTML = '<span class="inline-block animate-spin-slow mr-2">🔄</span> ' + selectedImages.length + '장 분석 중<span class="animate-pulse-slow">...</span>';
            btn.disabled = true;
            btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-gradient-to-r from-blue-500 to-purple-500 text-white cursor-not-allowed animate-pulse-slow';
            
            try {
                console.log('🚀 Sending request to /api/multi-analyze');
                
                const response = await fetch('/api/multi-analyze', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📊 Response data:', result);
                
                if (!response.ok) {
                    throw new Error(result.error || '분석에 실패했습니다.');
                }
                
                // Display results
                displayMultiImageResults(result);
                
            } catch (error) {
                console.error('❌ Analysis error:', error);
                errorText.textContent = error.message || '분석 중 오류가 발생했습니다.';
                errorDiv.style.display = 'block';
            } finally {
                // Reset button state
                btn.textContent = selectedImages.length + '장 분석하기';
                btn.disabled = false;
                btn.className = 'px-6 py-3 rounded-lg font-semibold transition-colors bg-blue-600 text-white hover:bg-blue-700';
            }
        }
        
        function displayMultiImageResults(result) {
            const resultDiv = document.getElementById('multiResult');
            const resultContent = document.getElementById('multiResultContent');
            
            // 분석 결과를 전역 변수에 저장 (Multi-AI 생성기에서 사용)
            window.lastMultiImageAnalysis = result;
            
            let html = '<div>';
            
            // Summary section
            html += '<div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6 mb-6">';
            html += '<h3 class="text-2xl font-bold mb-4">✅ 다중 이미지 공통 패턴 분석 완료!</h3>';
            html += '<div class="grid grid-cols-3 gap-4">';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + result.total_images + '장</div>';
            html += '<div class="text-sm opacity-90">분석된 이미지</div>';
            html += '</div>';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + (result.total_processing_time / 1000).toFixed(1) + '초</div>';
            html += '<div class="text-sm opacity-90">총 처리 시간</div>';
            html += '</div>';
            html += '<div class="bg-white/20 backdrop-blur rounded-lg p-3 text-center">';
            html += '<div class="text-2xl font-bold">' + (result.user_type === 'logged_in' ? '회원' : '게스트') + '</div>';
            html += '<div class="text-sm opacity-90">사용자 유형</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // Combined Analysis Results - Always show
            html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
            html += '<h4 class="text-xl font-bold mb-4">🎯 공통 패턴 분석 결과</h4>';
            
            if (result.combined_analysis && (result.combined_analysis.common_keywords.length > 0 || result.combined_analysis.common_colors.length > 0)) {
                
                // Pattern description
                html += '<div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 mb-4">';
                html += '<p class="text-lg text-gray-800">' + result.combined_analysis.pattern_description + '</p>';
                html += '</div>';
                
                // Analysis details grid
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
                html += '<div class="bg-blue-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-blue-900">지배적 스타일</div>';
                html += '<div class="text-blue-700 font-medium">' + result.combined_analysis.dominant_style + '</div>';
                html += '</div>';
                html += '<div class="bg-green-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-green-900">전체적 분위기</div>';
                html += '<div class="text-green-700 font-medium">' + result.combined_analysis.dominant_mood + '</div>';
                html += '</div>';
                html += '<div class="bg-purple-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-purple-900">평균 정확도</div>';
                html += '<div class="text-purple-700 font-medium">' + Math.round(result.combined_analysis.average_confidence * 100) + '%</div>';
                html += '</div>';
                html += '<div class="bg-orange-50 rounded-lg p-3">';
                html += '<div class="text-sm font-semibold text-orange-900">공통 요소</div>';
                html += '<div class="text-orange-700 font-medium">' + result.combined_analysis.common_keywords.length + '개</div>';
                html += '</div>';
                html += '</div>';
                
                // Common colors
                if (result.combined_analysis.common_colors && result.combined_analysis.common_colors.length > 0) {
                    html += '<div class="mb-4">';
                    html += '<h5 class="font-semibold text-gray-700 mb-2">🎨 공통 색상</h5>';
                    html += '<div class="flex flex-wrap gap-2">';
                    result.combined_analysis.common_colors.forEach(function(color) {
                        html += '<span class="bg-white border-2 border-gray-200 px-3 py-1 rounded-full text-sm font-medium">' + color + '</span>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                
                // Common keywords
                if (result.combined_analysis.common_keywords && result.combined_analysis.common_keywords.length > 0) {
                    html += '<div>';
                    html += '<h5 class="font-semibold text-gray-700 mb-2">🏷️ 공통 키워드</h5>';
                    html += '<div class="flex flex-wrap gap-2">';
                    result.combined_analysis.common_keywords.forEach(function(keyword) {
                        html += '<span class="bg-gray-100 px-3 py-1 rounded-full text-sm text-gray-700">' + keyword + '</span>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            } else {
                // No common patterns found - show helpful message
                html += '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">';
                html += '<p class="text-yellow-800">⚠️ 공통 패턴을 찾을 수 없었습니다. 이미지들이 서로 다른 특징을 가지고 있습니다.</p>';
                
                // Still show individual analyses summary
                if (result.individual_analyses && result.individual_analyses.length > 0) {
                    html += '<div class="mt-4">';
                    html += '<p class="text-sm font-semibold text-yellow-900 mb-2">개별 이미지 분석 요약:</p>';
                    html += '<ul class="text-sm text-yellow-700 space-y-1">';
                    result.individual_analyses.forEach(function(analysis, index) {
                        html += '<li>• ' + analysis.image_name + ': ';
                        html += (analysis.style || 'N/A') + ' 스타일, ';
                        html += (analysis.mood || 'N/A') + ' 분위기';
                        if (analysis.colors && analysis.colors.length > 0) {
                            html += ', 주요 색상: ' + analysis.colors.slice(0, 2).join(', ');
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            
            
            // Recommendations based on common patterns
            if (result.recommendations && result.recommendations.length > 0) {
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
                html += '<h4 class="text-xl font-bold mb-4">🎨 공통 패턴 기반 추천 작품</h4>';
                html += '<p class="text-gray-600 mb-4">선택하신 이미지들의 공통된 특징을 바탕으로 추천된 작품입니다.</p>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
                
                result.recommendations.forEach(function(rec) {
                    const artwork = rec.artwork || rec;
                    const imageUrl = artwork.image_url || artwork.thumbnail_url || '';
                    const title = artwork.title || '제목 없음';
                    const artist = artwork.artist || '작가 미상';
                    const similarity = Math.round((rec.similarity || 0) * 100);
                    
                    let source = 'Unknown';
                    if (artwork.metadata?.source) {
                        source = artwork.metadata.source;
                    } else if (artwork.source) {
                        source = artwork.source;
                    } else if (artwork.id?.startsWith('met_')) {
                        source = 'Met Museum';
                    } else if (artwork.id?.startsWith('local_')) {
                        source = 'Local DB';
                    }
                    
                    html += '<div class="bg-gray-50 rounded-lg p-4 hover:shadow-lg transition-all">';
                    html += '<div class="flex items-start space-x-3">';
                    if (imageUrl) {
                        html += '<img src="' + imageUrl + '" alt="' + title + '" class="w-24 h-24 object-cover rounded-lg" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">';
                        html += '<div class="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl" style="display:none;">🎨</div>';
                    } else {
                        html += '<div class="w-24 h-24 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl">🎨</div>';
                    }
                    html += '<div class="flex-1">';
                    html += '<h6 class="font-bold text-gray-900 mb-1">' + title + '</h6>';
                    html += '<p class="text-sm text-gray-600 mb-2">' + artist + '</p>';
                    html += '<div class="flex items-center justify-between">';
                    html += '<span class="text-xs px-2 py-1 bg-white rounded-full text-gray-600">' + source + '</span>';
                    html += '<span class="text-xs text-blue-600 font-semibold">' + similarity + '% 일치</span>';
                    html += '</div>';
                    if (artwork.source_url) {
                        html += '<a href="' + artwork.source_url + '" target="_blank" class="inline-block mt-2 text-xs text-blue-500 hover:text-blue-700 underline">상세보기 →</a>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>';
                html += '</div>';
            } else {
                // No recommendations found
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
                html += '<h4 class="text-xl font-bold mb-4">🎨 추천 작품</h4>';
                html += '<div class="bg-gray-50 rounded-lg p-6 text-center">';
                html += '<div class="text-4xl mb-2">🔍</div>';
                html += '<p class="text-gray-600">유사한 작품을 찾지 못했습니다.</p>';
                html += '<p class="text-sm text-gray-500 mt-2">다른 이미지로 시도해보시거나, 더 구체적인 특징이 있는 이미지를 선택해주세요.</p>';
                html += '</div>';
                html += '</div>';
            }
            
            // Individual image brief info (collapsed by default)
            if (result.individual_analyses && result.individual_analyses.length > 0) {
                html += '<details class="bg-gray-50 rounded-lg p-4">';
                html += '<summary class="cursor-pointer font-semibold text-gray-700 hover:text-gray-900">📋 개별 이미지 분석 상세 (클릭하여 펼치기)</summary>';
                html += '<div class="mt-4 space-y-3">';
                
                result.individual_analyses.forEach(function(imageResult, index) {
                    html += '<div class="bg-white rounded-lg p-4 border-l-2 border-gray-300">';
                    
                    // Image header (simplified)
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<div class="flex items-center space-x-2">';
                    html += '<span class="bg-gray-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">' + (index + 1) + '</span>';
                    html += '<span class="font-medium text-gray-800">' + imageResult.image_name + '</span>';
                    html += '</div>';
                    html += '<span class="text-xs text-gray-500">' + (imageResult.processing_time / 1000).toFixed(1) + '초</span>';
                    html += '</div>';
                    
                    // Simplified info in one line
                    html += '<div class="text-sm text-gray-600">';
                    html += '스타일: <span class="font-medium">' + (imageResult.style || 'N/A') + '</span> | ';
                    html += '분위기: <span class="font-medium">' + (imageResult.mood || 'N/A') + '</span> | ';
                    html += '색상: <span class="font-medium">' + (imageResult.colors ? imageResult.colors.slice(0, 3).join(', ') : 'N/A') + '</span>';
                    html += '</div>';
                    
                    html += '</div>';
                });
                
                html += '</div>';
                html += '</details>';
            }
            
            html += '</div>';
            
            resultContent.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // Store common analysis data globally for image generation
            window.lastCommonAnalysis = result.combined_analysis;
        }
        
        // 이미지 오류 처리 함수들
        function handleImageError(img) {
            console.log('❌ Image failed to load:', img.src);
            
            // 부모 카드 전체를 숨김
            const card = img.closest('[style*="border: 1px solid"]');
            if (card) {
                card.style.display = 'none';
                console.log('🚫 Hiding card with failed image:', img.alt);
            }
            
            // 통계 업데이트
            updateRecommendationStats();
        }
        
        function handleImageLoad(img) {
            console.log('✅ Image loaded successfully:', img.alt);
        }
        
        function updateRecommendationStats() {
            // 표시되는 카드 개수 업데이트
            const visibleCards = document.querySelectorAll('[style*="border: 1px solid"]:not([style*="display: none"])');
            const totalHeader = document.querySelector('h4[style*="추천 작품"]');
            if (totalHeader && visibleCards.length > 0) {
                totalHeader.innerHTML = '<strong>🎨 추천 작품 (' + visibleCards.length + '개 표시중)</strong>';
            }
        }

        // 단일 이미지 분석 관련 변수
        let singleImageFile = null;
        
        // 단일 이미지 분석 함수들
        function initSingleImageUpload() {
            const input = document.getElementById('singleImageInput');
            const uploadArea = document.getElementById('singleUploadArea');
            
            if (input) {
                input.addEventListener('change', handleSingleImageSelect);
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', handleSingleDragOver);
                uploadArea.addEventListener('dragleave', handleSingleDragLeave);
                uploadArea.addEventListener('drop', handleSingleDrop);
            }
        }
        
        function handleSingleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
        }
        
        function handleSingleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
        }
        
        function handleSingleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleSingleFile(files[0]);
            }
        }
        
        function handleSingleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleSingleFile(file);
            }
        }
        
        function handleSingleFile(file) {
            // 파일 검증
            if (!file.type.startsWith('image/')) {
                showSingleError('이미지 파일만 업로드 가능합니다.');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showSingleError('파일 크기는 10MB 이하여야 합니다.');
                return;
            }
            
            singleImageFile = file;
            
            // 이미지 미리보기 생성
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('singlePreviewImg');
                const imageInfo = document.getElementById('singleImageInfo');
                const uploadContent = document.getElementById('singleUploadContent');
                const imagePreview = document.getElementById('singleImagePreview');
                
                previewImg.src = e.target.result;
                imageInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                
                uploadContent.style.display = 'none';
                imagePreview.style.display = 'block';
                
                hideSingleError();
                hideSingleResult();
            };
            reader.readAsDataURL(file);
        }
        
        function clearSingleImage() {
            singleImageFile = null;
            
            const uploadContent = document.getElementById('singleUploadContent');
            const imagePreview = document.getElementById('singleImagePreview');
            const input = document.getElementById('singleImageInput');
            
            if (uploadContent) uploadContent.style.display = 'block';
            if (imagePreview) imagePreview.style.display = 'none';
            if (input) input.value = '';
            
            hideSingleError();
            hideSingleResult();
            hideSingleLoading();
        }
        
        async function analyzeSingleImage() {
            if (!singleImageFile) {
                showSingleError('이미지를 먼저 선택해주세요.');
                return;
            }
            
            showSingleLoading();
            hideSingleError();
            hideSingleResult();
            
            const formData = new FormData();
            formData.append('image', singleImageFile);
            
            // 사용자 정보가 있으면 추가
            const authData = checkAuthStatus();
            if (authData && authData.user && authData.user.id) {
                formData.append('userId', authData.user.id);
            } else {
                formData.append('userId', 'anonymous-' + Date.now());
            }
            
            try {
                console.log('🔍 단일 이미지 분석 시작...');
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                console.log('📊 분석 결과:', data);
                
                hideSingleLoading();
                
                if (data.success) {
                    displaySingleResult(data);
                } else {
                    showSingleError(data.error || '분석 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('분석 에러:', error);
                hideSingleLoading();
                showSingleError('서버와의 연결에 문제가 발생했습니다. 다시 시도해주세요.');
            }
        }
        
        function showSingleLoading() {
            const loading = document.getElementById('singleLoading');
            if (loading) loading.style.display = 'block';
            
            // Also update analyze button
            const btn = document.getElementById('singleAnalyzeBtn');
            if (btn) {
                btn.innerHTML = '<span class="inline-block animate-spin-slow mr-2">🔄</span> 분석 중<span class="animate-pulse-slow">...</span>';
                btn.disabled = true;
                btn.className = 'w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg animate-pulse-slow cursor-not-allowed';
            }
        }
        
        function hideSingleLoading() {
            const loading = document.getElementById('singleLoading');
            if (loading) loading.style.display = 'none';
            
            // Reset analyze button
            const btn = document.getElementById('singleAnalyzeBtn');
            if (btn) {
                btn.innerHTML = '✨ AI 분석 시작';
                btn.disabled = false;
                btn.className = 'w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg';
            }
        }
        
        function showSingleError(message) {
            const errorDiv = document.getElementById('singleError');
            const errorText = document.getElementById('singleErrorText');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function hideSingleError() {
            const errorDiv = document.getElementById('singleError');
            if (errorDiv) errorDiv.style.display = 'none';
        }
        
        function hideSingleResult() {
            const resultDiv = document.getElementById('singleResult');
            if (resultDiv) resultDiv.style.display = 'none';
        }
        
        function displaySingleResult(data) {
            const resultDiv = document.getElementById('singleResult');
            const analysisDetails = document.getElementById('singleAnalysisDetails');
            const recommendationsDiv = document.getElementById('singleRecommendations');
            
            if (!resultDiv || !analysisDetails || !recommendationsDiv) return;
            
            // 분석 정보 표시
            analysisDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold text-blue-900 mb-2">🎨 스타일</h4>
                        <p class="text-blue-700">${data.analysis.style || '분석 중...'}</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-900 mb-2">🌈 주요 색상</h4>
                        <p class="text-green-700">${data.analysis.colors?.join(', ') || '분석 중...'}</p>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h4 class="font-bold text-purple-900 mb-2">😊 분위기</h4>
                        <p class="text-purple-700">${data.analysis.mood || '분석 중...'}</p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4">
                        <h4 class="font-bold text-orange-900 mb-2">🎯 정확도</h4>
                        <p class="text-orange-700">${Math.round((data.analysis.confidence || 0) * 100)}%</p>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-gray-900 mb-2">🏷️ 키워드</h4>
                    <div class="flex flex-wrap gap-2">
                        ${data.analysis.keywords?.map(keyword => 
                            `<span class="bg-white px-3 py-1 rounded-full text-sm text-gray-700 border">${keyword}</span>`
                        ).join('') || '분석 중...'}
                    </div>
                </div>
                <div class="text-sm text-gray-600">
                    <p>⏱️ 처리 시간: ${data.processing_time}ms</p>
                    <p>📏 이미지 크기: ${(data.image_size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
            
            // 추천 작품 표시
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsDiv.innerHTML = `
                    <h4 class="text-base sm:text-lg font-bold mb-3 sm:mb-4 mt-4 sm:mt-6">🎨 추천 작품 (${data.recommendations.length}개)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        ${data.recommendations.map(rec => {
                            const artwork = rec.artwork || rec;
                            const imageUrl = artwork.image_url || artwork.thumbnail_url || '';
                            const title = artwork.title || '제목 없음';
                            const artist = artwork.artist || '작가 미상';
                            const similarity = Math.round((rec.similarity || 0) * 100);
                            
                            // 소스 결정
                            let source = 'Unknown';
                            if (artwork.metadata?.source) {
                                source = artwork.metadata.source;
                            } else if (artwork.source) {
                                source = artwork.source;
                            } else if (artwork.id?.startsWith('met_')) {
                                source = 'Met Museum';
                            } else if (artwork.id?.startsWith('local_')) {
                                source = 'Local DB';
                            }
                            
                            return `
                            <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-all">
                                <div class="flex items-start space-x-4">
                                    ${imageUrl ? 
                                        `<img src="${imageUrl}" alt="${title}" class="w-20 h-20 object-cover rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                         <div class="w-20 h-20 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl" style="display:none;">🎨</div>` : 
                                        `<div class="w-20 h-20 bg-gradient-to-br from-purple-100 to-blue-100 rounded-lg flex items-center justify-center text-purple-400 text-2xl">🎨</div>`
                                    }
                                    <div class="flex-1">
                                        <h5 class="font-bold text-gray-900 mb-1 line-clamp-2">${title}</h5>
                                        <p class="text-sm text-gray-600 mb-2">${artist}</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs px-2 py-1 bg-gray-100 rounded-full text-gray-600">${source}</span>
                                            <span class="text-xs text-blue-600 font-medium">${similarity}% 일치</span>
                                        </div>
                                        ${artwork.source_url ? 
                                            `<a href="${artwork.source_url}" target="_blank" class="inline-block mt-2 text-xs text-blue-500 hover:text-blue-700 underline">작품 상세보기 →</a>` : 
                                            ''
                                        }
                                    </div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                recommendationsDiv.innerHTML = `
                    <div class="text-center py-8 text-gray-500 mt-6">
                        <div class="text-4xl mb-2">🔍</div>
                        <p>유사한 작품을 찾지 못했습니다.</p>
                        <p class="text-sm mt-1">다른 이미지로 시도해보세요.</p>
                    </div>
                `;
            }
            
            resultDiv.style.display = 'block';
        }

        // Generate from manual keywords
        async function generateFromManualKeywords() {
            const keywordsInput = document.getElementById('manualKeywords');
            const keywords = keywordsInput.value.trim().split(',').map(k => k.trim()).filter(k => k);
            
            if (keywords.length === 0) {
                alert('키워드를 입력해주세요.');
                return;
            }
            
            // Get advanced options
            const style = document.getElementById('aiStyle')?.value || 'artistic';
            const mood = document.getElementById('aiMood')?.value || 'peaceful';
            const colors = document.getElementById('aiColors')?.value.split(',').map(c => c.trim()).filter(c => c) || [];
            const size = parseInt(document.getElementById('aiSize')?.value || '768');
            
            await generateAIImageWithParams(keywords, style, mood, colors, size);
        }
        
        // Common AI image generation function with parameters
        async function generateAIImageWithParams(keywords, style, mood, colors, size) {
            // Determine which result area to use based on current view
            const isGeneratorTab = document.getElementById('aiGeneratorResult') !== null;
            const area = isGeneratorTab ? document.getElementById('aiGeneratorResult') : document.getElementById('generatedImageArea');
            const content = isGeneratorTab ? document.getElementById('aiGeneratorContent') : document.getElementById('generatedImageContent');
            
            if (!area || !content) {
                console.error('Result area not found');
                return;
            }
            
            // Show loading
            area.classList.remove('hidden');
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin inline-block w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-600">AI가 이미지를 생성하고 있습니다...</p>
                    <p class="text-sm text-gray-500 mt-2">이 작업은 30초~1분 정도 소요될 수 있습니다</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        style: style,
                        mood: mood,
                        colors: colors,
                        width: size,
                        height: size
                    })
                });
                
                const result = await response.json();
                
                if (result.success || result.placeholder) {
                    // Display generated image
                    content.innerHTML = `
                        <div class="space-y-4">
                            <div class="relative">
                                <img src="${result.imageUrl}" alt="AI Generated Image" class="w-full rounded-lg shadow-lg">
                                ${result.placeholder ? '<div class="absolute top-2 right-2 bg-yellow-500 text-white px-3 py-1 rounded-full text-sm">테스트 이미지</div>' : ''}
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h5 class="font-semibold text-gray-700 mb-2">🎨 생성 프롬프트</h5>
                                <p class="text-sm text-gray-600 italic">${result.prompt || '자동 생성된 프롬프트'}</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <div class="text-sm font-semibold text-blue-900">처리 시간</div>
                                    <div class="text-blue-700 font-medium">${result.processingTime ? (result.processingTime / 1000).toFixed(1) + '초' : 'N/A'}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3">
                                    <div class="text-sm font-semibold text-green-900">생성 서비스</div>
                                    <div class="text-green-700 font-medium">${result.services ? result.services.join(', ') : 'Placeholder'}</div>
                                </div>
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="downloadGeneratedImage('${result.imageUrl}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                                    📥 이미지 다운로드
                                </button>
                                <button onclick="${isGeneratorTab ? 'generateFromManualKeywords()' : 'generateAIImage()'}" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                                    🔄 다시 생성하기
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Error occurred
                    content.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2 text-red-800">
                                <span class="text-2xl">❌</span>
                                <div>
                                    <p class="font-semibold">이미지 생성 실패</p>
                                    <p class="text-sm mt-1">${result.error || '알 수 없는 오류가 발생했습니다'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Image generation error:', error);
                content.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-800">❌ 이미지 생성 중 오류가 발생했습니다</p>
                    </div>
                `;
            }
        }
        
        // AI Image Generation Function
        async function generateAIImage() {
            if (!window.lastCommonAnalysis) {
                alert('먼저 다중 이미지 분석을 진행해주세요.');
                return;
            }
            
            const style = window.lastCommonAnalysis.dominant_style || 'artistic';
            const mood = window.lastCommonAnalysis.dominant_mood || 'balanced';
            const colors = window.lastCommonAnalysis.common_colors || [];
            const keywords = window.lastCommonAnalysis.common_keywords || [];
            
            // AI generation removed
            alert('이미지 생성 기능은 제거되었습니다.');
        }
        
        // Download generated image function
        function downloadGeneratedImage(imageUrl) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = 'ai-generated-image-' + Date.now() + '.png';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            // 단일 이미지 분석이 활성화될 때 이벤트 리스너를 설정하기 위해 setTimeout 사용
            setTimeout(initSingleImageUpload, 100);
        });
        // PayPal Modal Functions
        function showPayPalModal(imageCount) {
            const modal = document.getElementById('paypalModal');
            const priceElement = document.getElementById('paypalPrice');
            const countElement = document.getElementById('paypalImageCount');
            
            // Calculate price
            let price = 5; // Default for 4-10 images
            if (imageCount > 10) {
                price = 10; // Premium for 11+ images
            }
            
            countElement.textContent = imageCount + '장';
            priceElement.textContent = '$' + price + '.00';
            
            modal.classList.remove('hidden');
            
            // Render PayPal button
            renderPayPalButton(price, imageCount);
        }
        
        function closePayPalModal() {
            const modal = document.getElementById('paypalModal');
            modal.classList.add('hidden');
            
            // Clear PayPal button
            document.getElementById('paypal-button-container').innerHTML = '';
        }
        
        function renderPayPalButton(price, imageCount) {
            const container = document.getElementById('paypal-button-container');
            container.innerHTML = ''; // Clear previous buttons
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: price.toString(),
                                currency_code: 'USD'
                            },
                            description: 'AI Art Analysis - ' + imageCount + ' images'
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        console.log('✅ Payment successful:', details);
                        
                        // Store payment info
                        localStorage.setItem('paypalPaymentCompleted', JSON.stringify({
                            orderId: data.orderID,
                            imageCount: imageCount,
                            price: price,
                            timestamp: Date.now(),
                            payerName: details.payer.name.given_name + ' ' + details.payer.name.surname,
                            payerEmail: details.payer.email_address
                        }));
                        
                        // Show success message
                        document.getElementById('paypal-button-container').style.display = 'none';
                        document.getElementById('paypalSuccess').classList.remove('hidden');
                        
                        // Auto close and proceed with analysis after 2 seconds
                        setTimeout(function() {
                            closePayPalModal();
                            analyzeMultipleImages(); // Retry analysis after payment
                        }, 2000);
                    });
                },
                onError: function(err) {
                    console.error('❌ PayPal error:', err);
                    alert('결제 처리 중 오류가 발생했습니다. 다시 시도해주세요.');
                },
                onCancel: function(data) {
                    console.log('⚠️ Payment cancelled');
                }
            }).render('#paypal-button-container');
        }
    </script>
    
    <!-- PayPal Payment Modal -->
    <div id="paypalModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">💳 결제가 필요합니다</h2>
                    <p class="text-gray-600">4장 이상의 이미지 분석을 위해 결제가 필요합니다</p>
                    <p class="text-xs text-green-600 mt-2">✅ 실제 결제가 진행됩니다</p>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-medium">분석할 이미지:</span>
                        <span id="paypalImageCount" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-medium">결제 금액:</span>
                        <span id="paypalPrice" class="text-lg font-bold text-green-600"></span>
                    </div>
                </div>
                
                <!-- PayPal Button Container -->
                <div id="paypal-button-container" class="mb-4"></div>
                
                <!-- Cancel Button -->
                <button onclick="closePayPalModal()" class="w-full bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
                    취소
                </button>
                
                <!-- Success Message -->
                <div id="paypalSuccess" class="hidden text-center">
                    <div class="text-green-600 text-6xl mb-4">✓</div>
                    <h3 class="text-xl font-bold mb-2">결제가 완료되었습니다!</h3>
                    <p class="text-gray-600 mb-4">이제 이미지 분석을 진행합니다...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>