<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Art Community - 소셜 기능</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-50">
    <div id="root" class="min-h-screen">
        <!-- Loading placeholder -->
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
                AI Art Community
            </h1>
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-600">로딩 중...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // 아이콘 컴포넌트들
        const HeartIcon = ({ filled = false, className = "w-5 h-5" }) => (
            <svg className={className} fill={filled ? "currentColor" : "none"} stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
        );

        const MessageCircleIcon = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        );

        const UserPlusIcon = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        );

        const BellIcon = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M15 17h5l-5 5-5-5h5V3h0z" />
            </svg>
        );

        // 사용자 프로필 컴포넌트
        const UserProfile = ({ user, isOwn = false, onFollow, onUnfollow, isFollowing }) => {
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div className="flex items-center space-x-4">
                        <div className="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center">
                            {user.profile_image_url ? (
                                <img src={user.profile_image_url} alt="Profile" className="w-16 h-16 rounded-full object-cover" />
                            ) : (
                                <UserPlusIcon className="w-8 h-8 text-gray-500" />
                            )}
                        </div>
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-gray-800">
                                {user.display_name || user.email}
                            </h2>
                            {user.bio && (
                                <p className="text-gray-600 mt-1">{user.bio}</p>
                            )}
                            <div className="flex space-x-4 mt-2 text-sm text-gray-500">
                                <span>{user.followers_count || 0} 팔로워</span>
                                <span>{user.following_count || 0} 팔로잉</span>
                                <span>{user.likes_count || 0} 좋아요</span>
                            </div>
                        </div>
                        {!isOwn && (
                            <button
                                onClick={() => isFollowing ? onUnfollow(user.id) : onFollow(user.id)}
                                className={`px-4 py-2 rounded-lg ${
                                    isFollowing 
                                        ? 'bg-gray-500 hover:bg-gray-600 text-white' 
                                        : 'bg-blue-500 hover:bg-blue-600 text-white'
                                }`}
                            >
                                {isFollowing ? '언팔로우' : '팔로우'}
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // 포스트 컴포넌트
        const Post = ({ post, currentUser, onLike, onUnlike, onComment }) => {
            const [showComments, setShowComments] = useState(false);
            const [commentText, setCommentText] = useState('');
            const [comments, setComments] = useState([]);

            const handleLike = () => {
                if (post.is_liked) {
                    onUnlike(post.id);
                } else {
                    onLike(post.id);
                }
            };

            const handleComment = async () => {
                if (!commentText.trim()) return;
                
                const success = await onComment(post.id, commentText);
                if (success) {
                    setCommentText('');
                    // 댓글 목록 새로고침
                    loadComments();
                }
            };

            const loadComments = async () => {
                try {
                    const response = await fetch(`/api/social/comments/${post.id}`);
                    const result = await response.json();
                    if (result.success) {
                        setComments(result.comments);
                    }
                } catch (error) {
                    console.error('Failed to load comments:', error);
                }
            };

            useEffect(() => {
                if (showComments) {
                    loadComments();
                }
            }, [showComments]);

            return (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    {/* 포스트 헤더 */}
                    <div className="flex items-center space-x-3 mb-4">
                        <div className="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                            {post.user?.profile_image_url ? (
                                <img src={post.user.profile_image_url} alt="Profile" className="w-10 h-10 rounded-full object-cover" />
                            ) : (
                                <UserPlusIcon className="w-5 h-5 text-gray-500" />
                            )}
                        </div>
                        <div>
                            <h3 className="font-semibold text-gray-800">
                                {post.user?.display_name || post.user?.email || '익명'}
                            </h3>
                            <p className="text-sm text-gray-500">
                                {new Date(post.created_at).toLocaleDateString()}
                            </p>
                        </div>
                    </div>

                    {/* 포스트 내용 */}
                    <div className="mb-4">
                        <p className="text-gray-800 mb-3">{post.content}</p>
                        {post.image_url && (
                            <img src={post.image_url} alt="Post" className="w-full rounded-lg object-cover max-h-96" />
                        )}
                    </div>

                    {/* 포스트 액션 */}
                    <div className="flex items-center space-x-4 pt-3 border-t border-gray-200">
                        <button
                            onClick={handleLike}
                            className={`flex items-center space-x-2 ${
                                post.is_liked ? 'text-red-500' : 'text-gray-500 hover:text-red-500'
                            }`}
                        >
                            <HeartIcon filled={post.is_liked} />
                            <span>{post.likes_count}</span>
                        </button>
                        
                        <button
                            onClick={() => setShowComments(!showComments)}
                            className="flex items-center space-x-2 text-gray-500 hover:text-blue-500"
                        >
                            <MessageCircleIcon />
                            <span>{post.comments_count}</span>
                        </button>
                    </div>

                    {/* 댓글 섹션 */}
                    {showComments && (
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            {/* 댓글 입력 */}
                            {currentUser && (
                                <div className="flex space-x-3 mb-4">
                                    <div className="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                        <UserPlusIcon className="w-4 h-4 text-gray-500" />
                                    </div>
                                    <div className="flex-1">
                                        <textarea
                                            value={commentText}
                                            onChange={(e) => setCommentText(e.target.value)}
                                            placeholder="댓글을 입력하세요..."
                                            className="w-full p-2 border border-gray-300 rounded-lg resize-none"
                                            rows="2"
                                        />
                                        <button
                                            onClick={handleComment}
                                            className="mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                        >
                                            댓글 달기
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* 댓글 목록 */}
                            <div className="space-y-3">
                                {comments.map((comment) => (
                                    <div key={comment.id} className="flex space-x-3">
                                        <div className="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
                                            <UserPlusIcon className="w-4 h-4 text-gray-500" />
                                        </div>
                                        <div className="flex-1">
                                            <div className="bg-gray-100 rounded-lg p-3">
                                                <h4 className="font-semibold text-sm text-gray-800">
                                                    {comment.user?.display_name || comment.user?.email || '익명'}
                                                </h4>
                                                <p className="text-gray-700 mt-1">{comment.content}</p>
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">
                                                {new Date(comment.created_at).toLocaleDateString()}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 포스트 작성 컴포넌트
        const CreatePost = ({ user, onPostCreate }) => {
            const [content, setContent] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!content.trim() || isSubmitting) return;

                setIsSubmitting(true);
                try {
                    const response = await fetch('/api/social/post/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.id,
                            content: content.trim()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        setContent('');
                        onPostCreate(result.post);
                    } else {
                        alert('포스트 작성에 실패했습니다: ' + result.error);
                    }
                } catch (error) {
                    console.error('Failed to create post:', error);
                    alert('포스트 작성 중 오류가 발생했습니다.');
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <div className="flex items-start space-x-3">
                        <div className="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                            <UserPlusIcon className="w-5 h-5 text-gray-500" />
                        </div>
                        <form onSubmit={handleSubmit} className="flex-1">
                            <textarea
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="무엇을 공유하고 싶나요?"
                                className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"
                                disabled={isSubmitting}
                            />
                            <div className="flex justify-end mt-3">
                                <button
                                    type="submit"
                                    disabled={!content.trim() || isSubmitting}
                                    className="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                >
                                    {isSubmitting ? '게시 중...' : '게시하기'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // 메인 앱 컴포넌트
        const SocialApp = () => {
            const [user, setUser] = useState(null);
            const [posts, setPosts] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [activeTab, setActiveTab] = useState('feed');
            const [loading, setLoading] = useState(true);

            // 사용자 정보 로드
            const loadUser = async () => {
                try {
                    const response = await fetch('/api/auth/user');
                    const result = await response.json();
                    if (result.success) {
                        setUser(result.user);
                    }
                } catch (error) {
                    console.error('Failed to load user:', error);
                }
            };

            // 피드 포스트 로드
            const loadFeedPosts = async () => {
                try {
                    const url = user ? `/api/social/feed?userId=${user.id}` : '/api/social/feed';
                    const response = await fetch(url);
                    const result = await response.json();
                    if (result.success) {
                        setPosts(result.posts);
                    }
                } catch (error) {
                    console.error('Failed to load feed posts:', error);
                }
            };

            // 알림 로드
            const loadNotifications = async () => {
                if (!user) return;
                try {
                    const response = await fetch(`/api/social/notifications/${user.id}`);
                    const result = await response.json();
                    if (result.success) {
                        setNotifications(result.notifications);
                    }
                } catch (error) {
                    console.error('Failed to load notifications:', error);
                }
            };

            // 포스트 좋아요/취소
            const handlePostLike = async (postId) => {
                if (!user) return;
                try {
                    const response = await fetch('/api/social/post/like', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: user.id, postId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setPosts(posts.map(post => 
                            post.id === postId 
                                ? { ...post, is_liked: true, likes_count: post.likes_count + 1 }
                                : post
                        ));
                    }
                } catch (error) {
                    console.error('Failed to like post:', error);
                }
            };

            const handlePostUnlike = async (postId) => {
                if (!user) return;
                try {
                    const response = await fetch('/api/social/post/unlike', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: user.id, postId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setPosts(posts.map(post => 
                            post.id === postId 
                                ? { ...post, is_liked: false, likes_count: post.likes_count - 1 }
                                : post
                        ));
                    }
                } catch (error) {
                    console.error('Failed to unlike post:', error);
                }
            };

            // 댓글 작성
            const handleComment = async (postId, content) => {
                if (!user) return false;
                try {
                    const response = await fetch('/api/social/comment/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            post_id: postId,
                            content
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        setPosts(posts.map(post => 
                            post.id === postId 
                                ? { ...post, comments_count: post.comments_count + 1 }
                                : post
                        ));
                        return true;
                    }
                } catch (error) {
                    console.error('Failed to create comment:', error);
                }
                return false;
            };

            // 새 포스트 생성
            const handlePostCreate = (newPost) => {
                setPosts([newPost, ...posts]);
            };

            useEffect(() => {
                const initializeApp = async () => {
                    await loadUser();
                    setLoading(false);
                };
                initializeApp();
            }, []);

            useEffect(() => {
                if (!loading) {
                    loadFeedPosts();
                    loadNotifications();
                }
            }, [user, loading]);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* 헤더 */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <a href="/" className="text-2xl font-bold text-gray-800 hover:text-blue-600 transition-colors cursor-pointer">
                                    AI Art Community
                                </a>
                                <div className="flex items-center space-x-4">
                                    {user ? (
                                        <div className="flex items-center space-x-3">
                                            <span className="text-gray-700">{user.display_name || user.email}</span>
                                            <div className="relative">
                                                <BellIcon className="w-6 h-6 text-gray-600" />
                                                {notifications.filter(n => !n.is_read).length > 0 && (
                                                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                                        {notifications.filter(n => !n.is_read).length}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <a href="/" className="text-blue-500 hover:text-blue-600">로그인</a>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* 메인 컨텐츠 */}
                    <main className="container mx-auto px-4 py-8 max-w-2xl">
                        {user && (
                            <>
                                {/* 포스트 작성 */}
                                <CreatePost user={user} onPostCreate={handlePostCreate} />
                                
                                {/* 피드 */}
                                <div className="space-y-6">
                                    {posts.map((post) => (
                                        <Post
                                            key={post.id}
                                            post={post}
                                            currentUser={user}
                                            onLike={handlePostLike}
                                            onUnlike={handlePostUnlike}
                                            onComment={handleComment}
                                        />
                                    ))}
                                    
                                    {posts.length === 0 && (
                                        <div className="text-center py-12">
                                            <p className="text-gray-500 text-lg">아직 포스트가 없습니다.</p>
                                            <p className="text-gray-400">첫 번째 포스트를 작성해보세요!</p>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}

                        {!user && (
                            <div className="text-center py-12">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">환영합니다!</h2>
                                <p className="text-gray-600 mb-6">AI Art Community에 참여하려면 로그인이 필요합니다.</p>
                                <a
                                    href="/"
                                    className="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold"
                                >
                                    로그인하기
                                </a>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // 앱 렌더링
        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = createRoot(rootElement);
            root.render(<SocialApp />);
        }
    </script>
</body>
</html>